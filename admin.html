<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMPORIO 2026 - Admin Desk</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            font-size: 14px;
        }

        /* TOP BAR */
        .top-bar {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #404040;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .top-bar-left { display: flex; align-items: center; gap: 15px; }
        .top-bar-title { font-weight: bold; font-size: 1.1em; }
        .top-bar-session { font-size: 0.9em; opacity: 0.8; }
        .top-bar-right { display: flex; gap: 8px; align-items: center; }
        .sync-status {
            padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold;
        }
        .sync-status.active { background: #16a34a; color: #fff; }
        .sync-status.idle { background: #666; color: #fff; }

        .admin-btn {
            padding: 7px 16px;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .admin-btn:hover { background: rgba(255,255,255,0.2); }

        /* LAYOUT */
        .admin-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 0;
            height: calc(100vh - 48px);
        }

        /* LEFT: TRADE + ORDER BOOK */
        .trade-panel {
            padding: 15px;
            overflow-y: auto;
            background: #ffffff;
        }

        .section-title {
            font-size: 1.2em; font-weight: bold;
            margin-bottom: 12px; padding-bottom: 8px;
            border-bottom: 2px solid #000;
        }

        /* SESSION CONTROLS */
        .session-bar {
            background: #000;
            color: #fff;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        .session-bar .info { display: flex; gap: 20px; align-items: center; font-weight: bold; }
        .session-bar .btns { display: flex; gap: 8px; }
        .session-btn {
            padding: 8px 20px; font-weight: bold; font-size: 0.9em;
            border: 2px solid #fff; cursor: pointer; transition: all 0.2s;
        }
        .session-btn.primary { background: #fff; color: #000; }
        .session-btn.primary:hover { background: #e0e0e0; }
        .session-btn.primary:disabled { background: #666; color: #999; border-color: #666; cursor: not-allowed; }
        .session-btn.secondary { background: transparent; color: #fff; }
        .session-btn.secondary:hover { background: rgba(255,255,255,0.1); }
        .session-btn.secondary:disabled { opacity: 0.3; cursor: not-allowed; }
        .market-status-text.open { color: #4ade80; }
        .market-status-text.closing { color: #fbbf24; }
        .market-status-text.closed { color: #f87171; }

        /* TRADE FORM */
        .trade-form {
            display: grid;
            grid-template-columns: 1fr 1fr 100px 100px 120px auto;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f5f5f5;
            border: 2px solid #000;
        }
        .trade-form label { font-weight: bold; font-size: 0.85em; display: block; margin-bottom: 4px; }
        .trade-form select, .trade-form input {
            padding: 8px; border: 2px solid #000; font-size: 0.9em; width: 100%;
        }
        .trade-form button {
            padding: 8px 16px; background: #000; color: #fff; border: none;
            cursor: pointer; font-weight: bold; align-self: end; font-size: 0.9em;
            transition: all 0.2s;
        }
        .trade-form button:hover { background: #333; }

        /* ORDER BOOK */
        .order-book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .order-book-card {
            border: 2px solid #000; padding: 12px; background: #fff;
        }
        .order-book-card.matchable { border-color: #16a34a; background: #f0fdf4; }
        .ob-symbol { font-weight: bold; font-size: 1.1em; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #000; }
        .ob-side-label { font-weight: bold; font-size: 0.85em; margin-bottom: 4px; }
        .ob-side-label.sell { color: #dc2626; }
        .ob-side-label.buy { color: #16a34a; }
        .ob-order {
            padding: 5px 8px; margin-bottom: 3px; font-size: 0.83em;
            display: flex; justify-content: space-between; align-items: center;
        }
        .ob-order.sell-order { background: #ffe6e6; border-left: 3px solid #dc2626; }
        .ob-order.buy-order { background: #e6ffe6; border-left: 3px solid #16a34a; }
        .ob-cancel {
            padding: 2px 8px; border: none; color: #fff; cursor: pointer;
            font-weight: bold; font-size: 0.8em;
        }
        .ob-cancel.sell { background: #dc2626; }
        .ob-cancel.buy { background: #16a34a; }
        .ob-empty { color: #999; font-size: 0.85em; padding: 5px 0; }

        /* TRADES LOG */
        .trades-log {
            max-height: 300px; overflow-y: auto;
            border: 1px solid #000; background: #fafafa;
        }
        .trade-row {
            display: grid;
            grid-template-columns: 100px 100px 90px 70px 100px 100px;
            gap: 8px; padding: 7px 8px;
            border-bottom: 1px solid #e5e5e5;
            font-size: 0.83em; font-family: 'Courier New', monospace;
        }
        .trade-row.header {
            background: #000; color: #fff; font-weight: bold;
            position: sticky; top: 0;
        }
        .log-actions { display: flex; gap: 8px; margin-top: 10px; }
        .log-btn {
            padding: 8px 16px; font-weight: bold; cursor: pointer;
            border: 2px solid #000; background: #fff; transition: all 0.2s;
        }
        .log-btn:hover { background: #f0f0f0; }

        /* RIGHT: QUICK PRICES */
        .prices-panel {
            background: #fafafa;
            border-left: 2px solid #000;
            padding: 15px;
            overflow-y: auto;
        }
        .price-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin-bottom: 6px;
            border: 1px solid #e0e0e0; background: #fff;
            transition: all 0.2s;
        }
        .price-row:hover { border-color: #000; }
        .price-name { font-weight: bold; font-size: 0.95em; }
        .price-symbol { font-size: 0.8em; color: #666; }
        .price-val { font-weight: bold; font-family: 'Courier New', monospace; font-size: 1.05em; }
        .price-change-small { font-size: 0.8em; font-weight: bold; font-family: 'Courier New', monospace; }
        .price-change-small.pos { color: #16a34a; }
        .price-change-small.neg { color: #dc2626; }

        /* MODAL */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; z-index: 10001;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #fff; border: 3px solid #000; padding: 30px;
            max-width: 1200px; width: 95%; max-height: 95vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #000;
        }
        .modal-title { font-size: 1.8em; font-weight: bold; }
        .close-btn {
            background: #000; color: #fff; border: none; padding: 10px 20px;
            cursor: pointer; font-weight: bold; font-size: 1em;
        }
        .close-btn:hover { background: #333; }

        /* TABS */
        .tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #e5e5e5; }
        .tab {
            padding: 12px 24px; background: transparent; border: none;
            border-bottom: 3px solid transparent; cursor: pointer;
            font-weight: 600; font-size: 0.95em; color: #666; transition: all 0.2s;
        }
        .tab:hover { color: #000; }
        .tab.active { color: #000; border-bottom-color: #000; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* CONFIG */
        .config-section { margin-bottom: 25px; border: 2px solid #e5e5e5; padding: 20px; background: #fafafa; }
        .config-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #000; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
        .config-item { display: flex; flex-direction: column; gap: 4px; }
        .config-item label { font-weight: bold; font-size: 0.9em; }
        .config-item input, .config-item textarea, .config-item select {
            padding: 8px 10px; border: 2px solid #e5e5e5; font-size: 0.95em;
        }
        .config-item input:focus, .config-item textarea:focus, .config-item select:focus {
            outline: none; border-color: #000;
        }
        .config-item textarea { min-height: 70px; font-family: inherit; }
        .drift-grid { display: grid; grid-template-columns: 140px repeat(3, 1fr); gap: 8px; align-items: center; margin-bottom: 8px; }
        .drift-grid.header { font-weight: bold; background: #000; color: #fff; padding: 8px; }
        .drift-grid input { padding: 5px; border: 1px solid #000; }
        .btn-save {
            padding: 14px 28px; background: #000; color: #fff; border: none;
            cursor: pointer; font-weight: bold; font-size: 1.05em; width: 100%;
            transition: all 0.2s;
        }
        .btn-save:hover { background: #1a1a1a; }
        .btn-add {
            padding: 12px 24px; background: #000; color: #fff; border: 2px solid #000;
            cursor: pointer; font-weight: bold; margin-bottom: 15px;
        }
        .btn-add:hover { background: #333; }
        .btn-remove {
            padding: 8px 16px; background: #ef4444; color: #fff; border: none;
            cursor: pointer; font-weight: bold;
        }
        .btn-remove:hover { background: #dc2626; }

        /* HOLDINGS TABLE */
        .holdings-table {
            width: 100%; border-collapse: collapse;
            font-size: 0.83em; font-family: 'Courier New', monospace;
        }
        .holdings-table th {
            background: #000; color: #fff; padding: 7px 8px;
            text-align: center; font-weight: bold; white-space: nowrap;
        }
        .holdings-table th:first-child { text-align: left; }
        .holdings-table td { padding: 6px 8px; text-align: center; border-bottom: 1px solid #e5e5e5; }
        .holdings-table td:first-child { text-align: left; font-weight: bold; }
        .holdings-table tr:nth-child(even) { background: #f9f9f9; }
        .holdings-zero { color: #ccc; }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:99999;display:flex;align-items:center;justify-content:center;">
        <div style="text-align:center;color:#fff;max-width:400px;width:90%;">
            <div style="font-size:2.5em;font-weight:bold;margin-bottom:5px;">EMPORIO 2026</div>
            <div style="opacity:0.5;margin-bottom:40px;">Admin Desk</div>
            <div style="text-align:left;margin-bottom:8px;font-size:0.9em;opacity:0.7;">Room Key</div>
            <input type="text" id="roomKeyInput" placeholder="Enter room key..." style="width:100%;padding:14px 18px;font-size:1.1em;border:2px solid #444;background:#111;color:#fff;margin-bottom:20px;outline:none;" onkeydown="if(event.key==='Enter')joinRoom()">
            <button onclick="joinRoom()" style="width:100%;padding:14px;background:#fff;color:#000;border:none;font-weight:bold;font-size:1.1em;cursor:pointer;">Connect</button>
            <div style="margin-top:20px;font-size:0.8em;opacity:0.4;">Use the same key on the presentation screen to sync</div>
        </div>
    </div>

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="top-bar-title">EMPORIO 2026 ‚Äî Admin Desk</div>
            <div class="top-bar-session">Session <span id="sessionNum">1</span></div>
        </div>
        <div class="top-bar-right">
            <span class="sync-status idle" id="syncStatus">Not synced</span>
            <button class="admin-btn" onclick="broadcastFullSync()">üì° Force Sync</button>
            <button class="admin-btn" style="background:rgba(239,68,68,0.3);border-color:rgba(239,68,68,0.5);" onclick="fullReset()">üîÑ Reset All</button>
            <button class="admin-btn" onclick="openModal('stocks')">Stocks</button>
            <button class="admin-btn" onclick="openModal('teams')">Teams</button>
            <button class="admin-btn" onclick="openModal('drift')">Drift</button>
            <button class="admin-btn" onclick="openModal('news')">News</button>
            <button class="admin-btn" onclick="openModal('index')">Index</button>
            <button class="admin-btn" onclick="openModal('engine')">Engine</button>
        </div>
    </div>

    <div class="admin-layout">
        <!-- LEFT: TRADE AREA -->
        <div class="trade-panel">
            <!-- Session Controls -->
            <div class="session-bar">
                <div class="info">
                    <span>Session: <span id="sessionName">1</span></span>
                    <span id="marketClock">09:15</span>
                    <span class="market-status-text open" id="marketStatus">MARKET OPEN</span>
                </div>
                <div class="btns">
                    <button class="session-btn primary" id="startBtn" onclick="startSession()">‚ñ∂ Start Session</button>
                    <button class="session-btn secondary" id="pauseBtn" onclick="togglePause()" disabled>‚è∏ Pause</button>
                    <button class="session-btn secondary" id="skipBtn" onclick="skipToEnd()" disabled>‚è≠ Skip</button>
                    <button class="session-btn secondary" id="nextBtn" onclick="nextSession()" disabled>Next Session ‚Üí</button>
                </div>
            </div>

            <!-- Trade Entry -->
            <div class="section-title">üìä Execute Trade</div>
            <div class="trade-form" style="grid-template-columns: 1fr 1fr 1fr 100px 120px auto;">
                <div><label>Buyer</label><select id="tradeBuyer"></select></div>
                <div><label>Seller</label><select id="tradeSeller"></select></div>
                <div><label>Stock</label><select id="tradeStock"></select></div>
                <div><label>Qty</label><input type="number" id="tradeQty" placeholder="100" min="1"></div>
                <div><label>Price (‚Çπ)</label><input type="number" id="tradePrice" placeholder="850" step="0.01"></div>
                <div><button onclick="executeTrade()">Execute</button></div>
            </div>

            <!-- Executed Trades -->
            <div class="section-title">‚úÖ Executed Trades</div>
            <div class="trades-log">
                <div class="trade-row header">
                    <div>Buyer</div><div>Seller</div><div>Stock</div><div>Qty</div><div>Price</div><div>Time</div>
                </div>
                <div id="tradesLogContent"></div>
            </div>
            <div class="log-actions">
                <button class="log-btn" onclick="exportTrades()">üì• Export CSV</button>
                <button class="log-btn" onclick="clearTrades()">üóë Clear All</button>
            </div>

            <!-- Team Holdings -->
            <div class="section-title" style="margin-top:20px;">üìã Team Holdings</div>
            <div id="adminHoldingsTable" style="overflow-x:auto;"></div>
        </div>

        <!-- RIGHT: LIVE PRICES -->
        <div class="prices-panel">
            <div class="section-title" style="border-bottom-color:#000;">üìà Live Prices</div>
            <div id="pricesPanel"></div>
        </div>
    </div>

    <!-- ADMIN MODAL -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Admin Console</div>
                <button class="close-btn" onclick="closeModal()">‚úï Close</button>
            </div>
            <div class="tabs">
                <div class="tab" onclick="switchTab('stocks')">Stocks</div>
                <div class="tab active" onclick="switchTab('teams')">Teams</div>
                <div class="tab" onclick="switchTab('drift')">Price Drift</div>
                <div class="tab" onclick="switchTab('news')">Flash News</div>
                <div class="tab" onclick="switchTab('index')">Index Fund</div>
                <div class="tab" onclick="switchTab('engine')">Engine</div>
            </div>

            <!-- STOCKS -->
            <div class="tab-content" id="tab-stocks">
                <div class="config-section">
                    <div class="config-header">Stock List ‚Äî Edit names, tickers, and prices</div>
                    <div id="stockConfigContainer"></div>
                </div>
                <button class="btn-save" onclick="saveStockConfig()">üíæ Save Stocks</button>
            </div>

            <!-- TEAMS -->
            <div class="tab-content active" id="tab-teams">
                <button class="btn-add" onclick="addTeam()">+ Add Team</button>
                <div id="teamConfigContainer"></div>
                <button class="btn-save" onclick="saveTeamConfig()">üíæ Save Teams</button>
            </div>

            <!-- DRIFT -->
            <div class="tab-content" id="tab-drift">
                <div class="config-section" id="drift-s1"><div class="config-header">Session 1</div><div class="drift-grid header"><div>Stock</div><div>Min %</div><div>Max %</div><div>Mid %</div></div><div id="drift-session-1"></div></div>
                <div class="config-section" id="drift-s2"><div class="config-header">Session 2</div><div class="drift-grid header"><div>Stock</div><div>Min %</div><div>Max %</div><div>Mid %</div></div><div id="drift-session-2"></div></div>
                <div class="config-section" id="drift-s3"><div class="config-header">Session 3</div><div class="drift-grid header"><div>Stock</div><div>Min %</div><div>Max %</div><div>Mid %</div></div><div id="drift-session-3"></div></div>
                <button class="btn-save" onclick="saveDriftConfig()">üíæ Save Drift</button>
            </div>

            <!-- NEWS -->
            <div class="tab-content" id="tab-news">
                <div class="config-section"><div class="config-header">Session 1</div><div id="news-session-1"></div></div>
                <div class="config-section"><div class="config-header">Session 2</div><div id="news-session-2"></div></div>
                <div class="config-section"><div class="config-header">Session 3</div><div id="news-session-3"></div></div>
                <button class="btn-save" onclick="saveNewsConfig()">üíæ Save News</button>
            </div>

            <!-- INDEX -->
            <div class="tab-content" id="tab-index">
                <div class="config-section">
                    <div class="config-header">Index Fund</div>
                    <div class="config-grid">
                        <div class="config-item"><label>Index Name</label><input type="text" id="indexName" value="NIFTY 50"></div>
                        <div class="config-item"><label>Starting Value</label><input type="number" id="indexStart" value="21000"></div>
                    </div>
                    <div class="config-header" style="margin-top:15px;">Session Drift</div>
                    <div class="config-grid">
                        <div class="config-item"><label>Session 1 (%)</label><input type="number" id="indexDrift1" value="0.5" step="0.1"></div>
                        <div class="config-item"><label>Session 2 (%)</label><input type="number" id="indexDrift2" value="-0.3" step="0.1"></div>
                        <div class="config-item"><label>Session 3 (%)</label><input type="number" id="indexDrift3" value="0.8" step="0.1"></div>
                    </div>
                </div>
                <button class="btn-save" onclick="saveIndexConfig()">üíæ Save Index</button>
            </div>

            <!-- ENGINE -->
            <div class="tab-content" id="tab-engine">
                <div class="config-section">
                    <div class="config-header">Market Engine</div>
                    <div class="config-grid">
                        <div class="config-item"><label>Engine Mode</label>
                            <select id="engineEnabled" onchange="toggleMarketEngine()">
                                <option value="false">Disabled</option>
                                <option value="true">Built-in</option>
                                <option value="external" selected>Full Engine</option>
                            </select>
                        </div>
                        <div class="config-item"><label>Depth Factor</label><input type="number" id="engineDepth" value="0.25" step="0.001"></div>
                        <div class="config-item"><label>Impact Clamp (%)</label><input type="number" id="engineClamp" value="2.5" step="0.1"></div>
                    </div>
                    <div class="config-header" style="margin-top:15px;">Liquidity Coefficients (K)</div>
                    <div class="config-grid" id="engineKGrid"></div>
                </div>
                <button class="btn-save" onclick="saveEngineConfig()">üíæ Save Engine</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== EMBEDDED MARKET ENGINE ====================
        window.MarketEngine = {
            stockConfig: {
                ADANIPORTS: { startPrice: 850, dailyVolume: 2500000, K: 1.05 },
                LT: { startPrice: 3400, dailyVolume: 3200000, K: 1.00 },
                JSWSTEEL: { startPrice: 820, dailyVolume: 8500000, K: 0.85 },
                ONGC: { startPrice: 260, dailyVolume: 12800000, K: 0.75 },
                TCS: { startPrice: 4100, dailyVolume: 1800000, K: 1.15 },
                TITAN: { startPrice: 3600, dailyVolume: 2800000, K: 1.05 },
                CEATLTD: { startPrice: 2800, dailyVolume: 680000, K: 1.60 },
                SBIN: { startPrice: 720, dailyVolume: 18500000, K: 0.70 },
                NIFTY50: { startPrice: 21000, dailyVolume: 50000000, K: 0.50 }
            },
            params: { depthFactor: 0.25, perTradeImpactClamp: 0.025 },
            calculateImpact(symbol, side, qty, price) {
                const config = this.stockConfig[symbol];
                if (!config) return 0;
                const dir = side === 'BUY' ? 1 : -1;
                const tv = qty * price;
                const lv = (config.dailyVolume * config.startPrice) * this.params.depthFactor;
                const impact = dir * config.K * Math.sqrt(tv / lv);
                return Math.max(-this.params.perTradeImpactClamp, Math.min(this.params.perTradeImpactClamp, impact));
            }
        };

        // ==================== DATA ====================
        let teams = {
            'Team A': { cash: 500000, holdings: {} },
            'Team B': { cash: 500000, holdings: {} },
            'Team C': { cash: 500000, holdings: {} },
            'Team D': { cash: 500000, holdings: {} },
            'Team E': { cash: 500000, holdings: {} }
        };

        const stocks = [
            { name: 'Adani Ports', symbol: 'ADANIPORTS', price: 850, open: 850, volume: '2.5M', priceHistory: [850] },
            { name: 'L&T', symbol: 'LT', price: 3400, open: 3400, volume: '3.2M', priceHistory: [3400] },
            { name: 'JSW Steel', symbol: 'JSWSTEEL', price: 820, open: 820, volume: '8.5M', priceHistory: [820] },
            { name: 'ONGC', symbol: 'ONGC', price: 260, open: 260, volume: '12.8M', priceHistory: [260] },
            { name: 'TCS', symbol: 'TCS', price: 4100, open: 4100, volume: '1.8M', priceHistory: [4100] },
            { name: 'Titan', symbol: 'TITAN', price: 3600, open: 3600, volume: '2.8M', priceHistory: [3600] },
            { name: 'CEAT', symbol: 'CEATLTD', price: 2800, open: 2800, volume: '680K', priceHistory: [2800] },
            { name: 'State Bank of India', symbol: 'SBIN', price: 720, open: 720, volume: '18.5M', priceHistory: [720] }
        ];

        let indexFund = { name: 'NIFTY 50', symbol: 'NIFTY50', value: 21000, open: 21000, drift: { 1: 0.5, 2: -0.3, 3: 0.8 }, history: [21000], volume: '500M' };

        const marketEngine = { enabled: 'external',
            config: { ADANIPORTS:{dailyVolume:2500000,K:1.05}, LT:{dailyVolume:3200000,K:1.00}, JSWSTEEL:{dailyVolume:8500000,K:0.85}, ONGC:{dailyVolume:12800000,K:0.75}, TCS:{dailyVolume:1800000,K:1.15}, TITAN:{dailyVolume:2800000,K:1.05}, CEATLTD:{dailyVolume:680000,K:1.60}, SBIN:{dailyVolume:18500000,K:0.70}, NIFTY50:{dailyVolume:50000000,K:0.50} },
            params: { depthFactor: 0.25, impactClamp: 0.025 }
        };

        let flashNewsData = [
            { session:1, company:'ADANIPORTS', news:'Adani Ports reported Q3 revenue of ‚Çπ7,980 crore (+13% YoY) with EBITDA margin at 50.1%, while net debt rose to ‚Çπ51,900 crore following ‚Çπ3,000 crore capex during the quarter.', driftMin:-0.6, driftMax:0.8, driftMid:0.1 },
            { session:1, company:'LT', news:'L&T recorded order inflows of ‚Çπ70,200 crore, taking its backlog to ‚Çπ4.66 lakh crore, though operating cash flow remained negative due to ‚Çπ7,600 crore rise in receivables.', driftMin:-0.8, driftMax:0.9, driftMid:0.1 },
            { session:1, company:'TITAN', news:'Titan posted 15% revenue growth to ‚Çπ11,150 crore with EBITDA margin at 12.8%, while inventory days increased to 159 from 146 last quarter.', driftMin:-0.7, driftMax:1.0, driftMid:0.2 },
            { session:1, company:'JSWSTEEL', news:'JSW Steel reported EBITDA of ‚Çπ6,080 crore (margin 18.9%), down 120 bps QoQ, even as net debt declined marginally to ‚Çπ62,300 crore.', driftMin:-1.6, driftMax:-0.4, driftMid:-1.0 },
            { session:1, company:'ONGC', news:'ONGC realized $79/bbl crude with net profit up 8% YoY, though production volumes fell 2.5% and quarterly capex stood at ‚Çπ8,500 crore.', driftMin:-1.0, driftMax:0.6, driftMid:-0.2 },
            { session:1, company:'TCS', news:'TCS delivered ‚Çπ59,400 crore revenue (+8% YoY) with operating margin steady at 24.2%, while employee costs rose 11% year-on-year.', driftMin:0.6, driftMax:1.8, driftMid:1.2 },
            { session:1, company:'CEATLTD', news:'CEAT revenue grew 9% YoY to ‚Çπ3,040 crore, but EBITDA margin contracted to 11.2% as finance costs rose 18%.', driftMin:-2.8, driftMax:-1.2, driftMid:-2.0 },
            { session:1, company:'SBIN', news:'SBI reported NII of ‚Çπ41,500 crore (+17% YoY) with NIM at 3.42%, while unsecured retail advances grew 16% year-on-year.', driftMin:0.7, driftMax:1.9, driftMid:1.3 },
            { session:2, company:'ADANIPORTS', news:'The company approved ‚Çπ9,600 crore additional capex, projecting debt-to-EBITDA near 3.3x while maintaining margin guidance above 49%.', driftMin:-2.6, driftMax:-1.0, driftMid:-1.8 },
            { session:2, company:'LT', news:'Net profit rose 20% to ‚Çπ3,460 crore including ‚Çπ610 crore exceptional gains, while working capital cycle extended to 118 days.', driftMin:-1.2, driftMax:0.8, driftMid:-0.2 },
            { session:2, company:'TITAN', news:'Premium segment revenue rose 23% YoY, lifting EBITDA to ‚Çπ1,470 crore, though operating cash flow declined 15% sequentially.', driftMin:0.4, driftMax:1.6, driftMid:1.0 },
            { session:2, company:'JSWSTEEL', news:'JSW Steel approved ‚Çπ8,000 crore expansion capex as interest expense increased 15% YoY to ‚Çπ1,270 crore.', driftMin:-2.2, driftMax:-0.8, driftMid:-1.5 },
            { session:2, company:'ONGC', news:'ONGC declared ‚Çπ7/share interim dividend despite flat internal accruals and unchanged production guidance.', driftMin:-1.8, driftMax:-0.6, driftMid:-1.2 },
            { session:2, company:'TCS', news:'TCS trimmed margin outlook by 40 bps to 23.8% while maintaining revenue growth guidance near 8%.', driftMin:-2.4, driftMax:-0.9, driftMid:-1.6 },
            { session:2, company:'CEATLTD', news:'CEAT refinanced ‚Çπ1,200 crore debt at 8.2% average cost, while domestic volumes declined 2% sequentially.', driftMin:-1.0, driftMax:0.6, driftMid:-0.2 },
            { session:2, company:'SBIN', news:'Cost-to-income ratio rose to 52.3%, while SME slippages stood at ‚Çπ4,100 crore during the quarter.', driftMin:-2.0, driftMax:-0.7, driftMid:-1.3 },
            { session:3, company:'ADANIPORTS', news:'EBITDA margin held at 50.3%, though interest expense rose 21% YoY to ‚Çπ1,920 crore, moderating ROCE to 16.2%.', driftMin:-1.8, driftMax:-0.6, driftMid:-1.2 },
            { session:3, company:'LT', news:'Execution revenue grew 12% YoY, but receivables rose to ‚Çπ68,400 crore, keeping free cash flow under pressure.', driftMin:-3.0, driftMax:-1.2, driftMid:-2.1 },
            { session:3, company:'TITAN', news:'EBITDA margin remained near 13%, while inventory turnover declined to 2.3x and operating cash flow fell 17% sequentially.', driftMin:-2.8, driftMax:-1.0, driftMid:-1.9 },
            { session:3, company:'JSWSTEEL', news:'Net debt reduced to ‚Çπ60,850 crore, even as export realizations softened 3% sequentially.', driftMin:0.4, driftMax:1.6, driftMid:1.0 },
            { session:3, company:'ONGC', news:'Reserve replacement ratio stood at 0.94 while dividend payout remained above 45% of profit.', driftMin:-2.2, driftMax:-0.8, driftMid:-1.5 },
            { session:3, company:'TCS', news:'Deal wins stood at $9.7 billion for the quarter, though revenue per employee declined 2.6% sequentially.', driftMin:-2.6, driftMax:-1.0, driftMid:-1.8 },
            { session:3, company:'CEATLTD', news:'EBITDA margin improved to 11.8%, while working capital days increased to 64 from 58.', driftMin:-0.8, driftMax:0.8, driftMid:0.0 },
            { session:3, company:'SBIN', news:'Loan growth reached 19% YoY, with provision coverage improving to 77% despite treasury MTM losses of ‚Çπ1,700 crore.', driftMin:0.3, driftMax:1.3, driftMid:0.8 }
        ];

        let currentSession = 1;
        let sessionStartTime = null;
        let sessionPaused = false;
        let sessionPausedAt = null;
        let sessionElapsedBeforePause = 0;
        let marketClockInterval = null;
        let allPriceAnimations = [];
        let tradeLog = [];
        let newsHistory = [];
        let isFlashNewsRunning = false;
        let currentNewsIndex = 0;
        const SESSION_DURATION_MS = 15 * 60 * 1000;
        const MARKET_START_TIME = { hours: 9, minutes: 15 };
        let orderBook = {};
        let orderIdCounter = 1;

        // ==================== FIREBASE SYNC ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBJUPdflVt2VIe0apilNKNYmZhC1e2JsP4",
            authDomain: "emporio-2026.firebaseapp.com",
            databaseURL: "https://emporio-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "emporio-2026",
            storageBucket: "emporio-2026.firebasestorage.app",
            messagingSenderId: "502003603114",
            appId: "1:502003603114:web:834d5f6e7d5f9fe22ba2d3"
        };
        firebase.initializeApp(firebaseConfig);
        const fbDb = firebase.database();
        let roomKey = null;
        let db = null; // will be set to fbDb.ref('rooms/' + roomKey)

        function joinRoom() {
            const key = document.getElementById('roomKeyInput').value.trim();
            if (!key) return alert('Enter a room key!');
            if (/[.#$/\[\]]/.test(key)) return alert('Room key cannot contain . # $ / [ ]');
            roomKey = key;
            db = {
                ref: (path) => fbDb.ref('rooms/' + roomKey + '/' + path)
            };
            document.getElementById('loginScreen').style.display = 'none';
            // Push initial state to this room
            broadcastFullSync();
        }

        function buildSyncPayload() {
            return {
                stocks: stocks.map(s => ({ symbol: s.symbol, name: s.name, price: s.price, open: s.open, volume: s.volume })),
                indexFund: { value: indexFund.value, open: indexFund.open, name: indexFund.name, symbol: indexFund.symbol, volume: indexFund.volume },
                teams: JSON.parse(JSON.stringify(teams)),
                currentSession,
                clock: document.getElementById('marketClock').textContent,
                marketStatus: {
                    text: document.getElementById('marketStatus').textContent,
                    class: document.getElementById('marketStatus').className.replace('market-status-text ', '')
                },
                timestamp: Date.now()
            };
        }

        function broadcastFullSync() {
            db.ref('gameState').set(buildSyncPayload());
            db.ref('newsHistory').set(newsHistory.filter(n => n.session === currentSession));
            flashSyncStatus();
        }

        function broadcastStateUpdate() {
            db.ref('gameState').set(buildSyncPayload());
            flashSyncStatus();
        }

        function broadcastFlashNews(company, text) {
            db.ref('flashNews').set({ company, text, timestamp: Date.now() });
        }

        function broadcastSessionReset() {
            db.ref('newsHistory').set([]);
            db.ref('flashNews').remove();
            db.ref('gameState').set(buildSyncPayload());
        }

        function flashSyncStatus() {
            const el = document.getElementById('syncStatus');
            el.textContent = 'üì° Synced'; el.className = 'sync-status active';
            clearTimeout(el._timer);
            el._timer = setTimeout(() => { el.textContent = 'Idle'; el.className = 'sync-status idle'; }, 2000);
        }

        // Auto-sync every 2 seconds when session is running
        setInterval(() => {
            if (sessionStartTime) broadcastStateUpdate();
        }, 2000);

        // ==================== HELPERS ====================
        function formatINR(num) {
            const numStr = Math.round(num).toString();
            const lastThree = numStr.substring(numStr.length - 3);
            const otherNumbers = numStr.substring(0, numStr.length - 3);
            if (otherNumbers !== '') return otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + "," + lastThree;
            return lastThree;
        }

        function initOrderBook() {
            stocks.forEach(s => { orderBook[s.symbol] = { buys: [], sells: [] }; });
            orderBook['NIFTY50'] = { buys: [], sells: [] };
        }

        // ==================== ADMIN MODAL ====================
        function openModal(tab) { document.getElementById('adminModal').classList.add('show'); switchTab(tab); }
        function closeModal() { document.getElementById('adminModal').classList.remove('show'); }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            const tabIndex = ['stocks','teams','drift','news','index','engine'].indexOf(tabName);
            document.querySelectorAll('.tab')[tabIndex]?.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (tabName === 'stocks') renderStockConfig();
            if (tabName === 'teams') renderTeamConfig();
            if (tabName === 'drift') renderDriftConfig();
            if (tabName === 'news') renderNewsConfig();
            if (tabName === 'engine') renderEngineK();
        }

        // STOCK CONFIG
        function renderStockConfig() {
            const container = document.getElementById('stockConfigContainer');
            let html = '<div style="display:grid;grid-template-columns:200px 130px 120px 120px auto;gap:8px;padding:8px;background:#000;color:#fff;font-weight:bold;margin-bottom:4px;">' +
                '<div>Company Name</div><div>Ticker</div><div>Current Price</div><div>Open Price</div><div>Volume</div></div>';

            stocks.forEach((s, idx) => {
                html += `<div style="display:grid;grid-template-columns:200px 130px 120px 120px auto;gap:8px;padding:6px 8px;border-bottom:1px solid #e5e5e5;align-items:center;">
                    <input type="text" value="${s.name}" id="stock-name-${idx}" style="padding:6px;border:2px solid #e0e0e0;">
                    <input type="text" value="${s.symbol}" id="stock-symbol-${idx}" style="padding:6px;border:2px solid #e0e0e0;font-family:'Courier New',monospace;">
                    <input type="number" value="${s.price.toFixed(2)}" id="stock-price-${idx}" step="0.01" style="padding:6px;border:2px solid #e0e0e0;font-family:'Courier New',monospace;">
                    <input type="number" value="${s.open.toFixed(2)}" id="stock-open-${idx}" step="0.01" style="padding:6px;border:2px solid #e0e0e0;font-family:'Courier New',monospace;">
                    <input type="text" value="${s.volume}" id="stock-vol-${idx}" style="padding:6px;border:2px solid #e0e0e0;">
                </div>`;
            });

            // Index fund row
            html += '<div style="margin-top:15px;padding-top:15px;border-top:3px solid #000;">';
            html += '<div style="font-weight:bold;margin-bottom:8px;">Index Fund</div>';
            html += `<div style="display:grid;grid-template-columns:200px 130px 120px 120px auto;gap:8px;align-items:center;">
                <input type="text" value="${indexFund.name}" id="idx-name" style="padding:6px;border:2px solid #e0e0e0;">
                <input type="text" value="${indexFund.symbol}" id="idx-symbol" style="padding:6px;border:2px solid #e0e0e0;font-family:'Courier New',monospace;">
                <input type="number" value="${indexFund.value.toFixed(2)}" id="idx-price" step="0.01" style="padding:6px;border:2px solid #e0e0e0;font-family:'Courier New',monospace;">
                <input type="number" value="${indexFund.open.toFixed(2)}" id="idx-open" step="0.01" style="padding:6px;border:2px solid #e0e0e0;font-family:'Courier New',monospace;">
                <input type="text" value="${indexFund.volume}" id="idx-vol" style="padding:6px;border:2px solid #e0e0e0;">
            </div></div>`;

            container.innerHTML = html;
        }

        function saveStockConfig() {
            stocks.forEach((s, idx) => {
                const newName = document.getElementById(`stock-name-${idx}`).value;
                const newSymbol = document.getElementById(`stock-symbol-${idx}`).value;
                const newPrice = parseFloat(document.getElementById(`stock-price-${idx}`).value);
                const newOpen = parseFloat(document.getElementById(`stock-open-${idx}`).value);
                const newVol = document.getElementById(`stock-vol-${idx}`).value;

                // Update symbol in team holdings if ticker changed
                if (newSymbol !== s.symbol) {
                    Object.values(teams).forEach(team => {
                        if (team.holdings[s.symbol] !== undefined) {
                            team.holdings[newSymbol] = team.holdings[s.symbol];
                            delete team.holdings[s.symbol];
                        }
                    });
                    // Update order book
                    if (orderBook[s.symbol]) {
                        orderBook[newSymbol] = orderBook[s.symbol];
                        delete orderBook[s.symbol];
                    }
                }

                s.name = newName || s.name;
                s.symbol = newSymbol || s.symbol;
                if (!isNaN(newPrice)) s.price = newPrice;
                if (!isNaN(newOpen)) s.open = newOpen;
                s.volume = newVol || s.volume;
            });

            // Index fund
            indexFund.name = document.getElementById('idx-name').value || indexFund.name;
            indexFund.symbol = document.getElementById('idx-symbol').value || indexFund.symbol;
            const idxPrice = parseFloat(document.getElementById('idx-price').value);
            const idxOpen = parseFloat(document.getElementById('idx-open').value);
            if (!isNaN(idxPrice)) indexFund.value = idxPrice;
            if (!isNaN(idxOpen)) indexFund.open = idxOpen;
            indexFund.volume = document.getElementById('idx-vol').value || indexFund.volume;

            updateTeamDropdown();
            renderPricesPanel();
            broadcastStateUpdate();
            alert('Stocks saved!');
        }

        // TEAM CONFIG
        function renderTeamConfig() {
            const container = document.getElementById('teamConfigContainer');
            container.innerHTML = '';
            Object.entries(teams).forEach(([name, data], idx) => {
                const section = document.createElement('div');
                section.className = 'config-section';
                let html = `<div style="display:flex;gap:10px;margin-bottom:12px;align-items:center;">
                    <input type="text" value="${name}" id="team-name-${idx}" style="padding:8px;border:2px solid #000;flex:1;" placeholder="Team Name">
                    <input type="number" value="${data.cash}" id="team-cash-${idx}" style="padding:8px;border:2px solid #000;width:140px;" placeholder="Cash">
                    <button class="btn-remove" data-team="${name}" onclick="removeTeam(this.getAttribute('data-team'))">Remove</button>
                </div>`;
                html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">';
                html += `<div class="config-item"><label>NIFTY50</label><input type="number" value="${data.holdings['NIFTY50']||0}" id="team-${idx}-NIFTY50"></div>`;
                stocks.forEach(s => {
                    html += `<div class="config-item"><label>${s.symbol}</label><input type="number" value="${data.holdings[s.symbol]||0}" id="team-${idx}-${s.symbol}"></div>`;
                });
                html += '</div>';
                section.innerHTML = html;
                container.appendChild(section);
            });
        }

        function addTeam() {
            const num = Object.keys(teams).length + 1;
            const name = `Team ${String.fromCharCode(64 + num)}`;
            teams[name] = { cash: 500000, holdings: {} };
            teams[name].holdings['NIFTY50'] = Math.floor(62500 / indexFund.open);
            stocks.forEach(s => teams[name].holdings[s.symbol] = Math.floor(50000 / s.open));
            renderTeamConfig();
        }

        function removeTeam(teamName) {
            if (Object.keys(teams).length <= 2) { alert('Need at least 2 teams!'); return; }
            if (!teams[teamName]) { alert('Team not found: ' + teamName); return; }
            delete teams[teamName];
            renderTeamConfig();
            updateTeamDropdown();
            renderPricesPanel();
            broadcastStateUpdate();
        }

        function saveTeamConfig() {
            const newTeams = {};
            Object.keys(teams).forEach((old, idx) => {
                const name = document.getElementById(`team-name-${idx}`).value || `Team ${idx+1}`;
                const cash = parseInt(document.getElementById(`team-cash-${idx}`).value) || 500000;
                const holdings = {};
                holdings['NIFTY50'] = parseInt(document.getElementById(`team-${idx}-NIFTY50`).value) || 0;
                stocks.forEach(s => { holdings[s.symbol] = parseInt(document.getElementById(`team-${idx}-${s.symbol}`).value) || 0; });
                newTeams[name] = { cash, holdings };
            });
            teams = newTeams;
            updateTeamDropdown();
            broadcastStateUpdate();
            alert('Teams saved!');
        }

        // DRIFT CONFIG
        function renderDriftConfig() {
            [1,2,3].forEach(session => {
                const container = document.getElementById(`drift-session-${session}`);
                container.innerHTML = '';
                stocks.forEach(stock => {
                    const news = flashNewsData.find(n => n.session === session && n.company === stock.symbol);
                    if (news) {
                        container.innerHTML += `<div class="drift-grid">
                            <div style="font-weight:bold">${stock.symbol}</div>
                            <input type="number" step="0.1" value="${news.driftMin}" id="drift-${session}-${stock.symbol}-min">
                            <input type="number" step="0.1" value="${news.driftMax}" id="drift-${session}-${stock.symbol}-max">
                            <input type="number" step="0.1" value="${news.driftMid}" id="drift-${session}-${stock.symbol}-mid">
                        </div>`;
                    }
                });
            });
        }
        function saveDriftConfig() {
            flashNewsData.forEach(news => {
                const min = parseFloat(document.getElementById(`drift-${news.session}-${news.company}-min`)?.value);
                const max = parseFloat(document.getElementById(`drift-${news.session}-${news.company}-max`)?.value);
                const mid = parseFloat(document.getElementById(`drift-${news.session}-${news.company}-mid`)?.value);
                if (!isNaN(min)) news.driftMin = min;
                if (!isNaN(max)) news.driftMax = max;
                if (!isNaN(mid)) news.driftMid = mid;
            });
            alert('Drift saved!');
        }

        // NEWS CONFIG
        function renderNewsConfig() {
            [1,2,3].forEach(session => {
                const container = document.getElementById(`news-session-${session}`);
                container.innerHTML = '';
                stocks.forEach(stock => {
                    const news = flashNewsData.find(n => n.session === session && n.company === stock.symbol);
                    if (news) {
                        container.innerHTML += `<div class="config-item"><label>${stock.name} (${stock.symbol})</label><textarea id="news-${session}-${stock.symbol}">${news.news}</textarea></div>`;
                    }
                });
            });
        }
        function saveNewsConfig() {
            flashNewsData.forEach(news => {
                const text = document.getElementById(`news-${news.session}-${news.company}`)?.value;
                if (text) news.news = text;
            });
            alert('News saved!');
        }

        // INDEX CONFIG
        function saveIndexConfig() {
            indexFund.name = document.getElementById('indexName').value;
            indexFund.value = parseFloat(document.getElementById('indexStart').value);
            indexFund.open = indexFund.value;
            indexFund.drift[1] = parseFloat(document.getElementById('indexDrift1').value);
            indexFund.drift[2] = parseFloat(document.getElementById('indexDrift2').value);
            indexFund.drift[3] = parseFloat(document.getElementById('indexDrift3').value);
            indexFund.history = [indexFund.value];
            broadcastStateUpdate();
            alert('Index saved!');
        }

        // ENGINE CONFIG
        function renderEngineK() {
            const grid = document.getElementById('engineKGrid');
            grid.innerHTML = '';
            Object.keys(marketEngine.config).forEach(sym => {
                grid.innerHTML += `<div class="config-item"><label>${sym} (K)</label><input type="number" id="engineK-${sym}" value="${marketEngine.config[sym].K}" step="0.05"></div>`;
            });
        }
        function toggleMarketEngine() {
            const mode = document.getElementById('engineEnabled').value;
            if (mode === 'external') {
                if (window.MarketEngine?.calculateImpact) { marketEngine.enabled = 'external'; alert('Full Market Engine ENABLED'); }
                else { document.getElementById('engineEnabled').value = 'false'; marketEngine.enabled = false; }
            } else { marketEngine.enabled = mode === 'true'; alert(`Engine ${marketEngine.enabled ? 'ENABLED' : 'DISABLED'}`); }
        }
        function saveEngineConfig() {
            marketEngine.params.depthFactor = parseFloat(document.getElementById('engineDepth').value);
            marketEngine.params.impactClamp = parseFloat(document.getElementById('engineClamp').value) / 100;
            Object.keys(marketEngine.config).forEach(sym => {
                const k = parseFloat(document.getElementById(`engineK-${sym}`)?.value);
                if (!isNaN(k)) marketEngine.config[sym].K = k;
            });
            alert('Engine config saved!');
        }

        // ==================== GAME LOGIC ====================
        function initializeTeamHoldings() {
            Object.keys(teams).forEach(name => {
                stocks.forEach(stock => { if (!teams[name].holdings[stock.symbol]) teams[name].holdings[stock.symbol] = Math.floor(50000 / stock.open); });
                if (!teams[name].holdings['NIFTY50']) teams[name].holdings['NIFTY50'] = Math.floor(62500 / indexFund.open);
            });
            updateTeamDropdown();
        }

        function updateTeamDropdown() {
            // Populate buyer and seller dropdowns
            ['tradeBuyer', 'tradeSeller'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                Object.keys(teams).forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.textContent = name; select.appendChild(opt); });
            });
            // Set seller to second team by default
            const sellerSelect = document.getElementById('tradeSeller');
            if (sellerSelect.options.length > 1) sellerSelect.selectedIndex = 1;

            const stockSelect = document.getElementById('tradeStock');
            stockSelect.innerHTML = '';
            const idx = document.createElement('option'); idx.value = indexFund.symbol; idx.textContent = `${indexFund.name} (${indexFund.symbol})`; stockSelect.appendChild(idx);
            stocks.forEach(s => { const opt = document.createElement('option'); opt.value = s.symbol; opt.textContent = `${s.name} (${s.symbol})`; stockSelect.appendChild(opt); });
        }

        function calculateMarketImpact(symbol, side, qty, price) {
            if (marketEngine.enabled === 'external' && window.MarketEngine?.calculateImpact) {
                try { return window.MarketEngine.calculateImpact(symbol, side, qty, price); } catch(e) { return 0; }
            }
            if (!marketEngine.enabled) return 0;
            const config = marketEngine.config[symbol]; if (!config) return 0;
            const instrument = symbol === 'NIFTY50' ? indexFund : stocks.find(s => s.symbol === symbol);
            if (!instrument) return 0;
            const dir = side === 'BUY' ? 1 : -1;
            const tv = qty * price;
            const cp = instrument.value || instrument.price;
            const lv = (config.dailyVolume * cp) * marketEngine.params.depthFactor;
            const impact = dir * config.K * Math.sqrt(tv / lv);
            return Math.max(-marketEngine.params.impactClamp, Math.min(marketEngine.params.impactClamp, impact));
        }

        // ==================== TRADING ====================
        function executeTrade() {
            const buyerName = document.getElementById('tradeBuyer').value;
            const sellerName = document.getElementById('tradeSeller').value;
            const symbol = document.getElementById('tradeStock').value;
            const qty = parseInt(document.getElementById('tradeQty').value);
            const price = parseFloat(document.getElementById('tradePrice').value);

            if (!buyerName || !sellerName) return alert('Select both buyer and seller!');
            if (buyerName === sellerName) return alert('Buyer and seller must be different teams!');
            if (!qty || qty <= 0) return alert('Enter valid quantity!');
            if (!price || price <= 0) return alert('Enter valid price!');

            const buyer = teams[buyerName];
            const seller = teams[sellerName];
            if (!buyer || !seller) return alert('Team not found!');

            const value = qty * price;

            // Validate
            if (buyer.cash < value) return alert(`Insufficient cash!\n${buyerName}: ‚Çπ${formatINR(buyer.cash)}\nNeeds: ‚Çπ${formatINR(value)}`);
            if ((seller.holdings[symbol] || 0) < qty) return alert(`Insufficient shares!\n${sellerName}: ${seller.holdings[symbol]||0} ${symbol}\nTrying to sell: ${qty}`);

            // Execute directly
            buyer.cash -= value;
            buyer.holdings[symbol] = (buyer.holdings[symbol] || 0) + qty;
            seller.cash += value;
            seller.holdings[symbol] -= qty;

            // Log
            tradeLog.unshift({ buyer: buyerName, seller: sellerName, symbol, qty, price, value, timestamp: new Date() });

            // Price impact
            const isIndex = symbol === indexFund.symbol;
            if (isIndex) {
                const impact = calculateMarketImpact(symbol, 'BUY', qty, price);
                indexFund.value = marketEngine.enabled ? indexFund.value * (1 + impact) : price;
            } else {
                const stock = stocks.find(s => s.symbol === symbol);
                if (stock) {
                    const impact = calculateMarketImpact(symbol, 'BUY', qty, price);
                    stock.price = marketEngine.enabled ? stock.price * (1 + impact) : price;
                }
            }

            renderTradeLog();
            renderPricesPanel();
            renderAdminHoldings();
            broadcastStateUpdate();

            document.getElementById('tradeQty').value = '';
            document.getElementById('tradePrice').value = '';

            alert(`‚úÖ Trade executed!\n\n${buyerName} bought ${qty} ${symbol} from ${sellerName}\n@ ‚Çπ${price.toFixed(2)} (Total: ‚Çπ${formatINR(value)})`);
        }

        function matchOrders(symbol) {
            const book = orderBook[symbol];
            while (book.buys.length > 0 && book.sells.length > 0) {
                const buy = book.buys[0], sell = book.sells[0];
                if (buy.price < sell.price) break;

                const tq = Math.min(buy.qty, sell.qty);
                const tp = sell.price;
                const tv = tq * tp;

                teams[buy.team].cash -= tv;
                teams[buy.team].holdings[symbol] = (teams[buy.team].holdings[symbol]||0) + tq;
                teams[sell.team].cash += tv;
                teams[sell.team].holdings[symbol] -= tq;

                tradeLog.unshift({ buyer: buy.team, seller: sell.team, symbol, qty: tq, price: tp, value: tv, timestamp: new Date() });

                // Price impact
                if (symbol === 'NIFTY50') {
                    const impact = calculateMarketImpact(symbol, 'BUY', tq, tp);
                    indexFund.value = marketEngine.enabled ? indexFund.value * (1+impact) : tp;
                } else {
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (stock) {
                        const impact = calculateMarketImpact(symbol, 'BUY', tq, tp);
                        stock.price = marketEngine.enabled ? stock.price * (1+impact) : tp;
                    }
                }

                buy.qty -= tq; sell.qty -= tq;
                if (buy.qty === 0) book.buys.shift();
                if (sell.qty === 0) book.sells.shift();

                renderTradeLog();
                renderPricesPanel();
                broadcastStateUpdate();
            }
        }

        function cancelOrder(id, symbol, side) {
            const orders = side === 'BUY' ? orderBook[symbol].buys : orderBook[symbol].sells;
            const idx = orders.findIndex(o => o.id === id);
            if (idx !== -1) { orders.splice(idx, 1); renderOrderBook(); }
        }

        function renderOrderBook() {
            const container = document.getElementById('orderBookContent');
            const syms = Object.keys(orderBook).filter(s => orderBook[s].buys.length > 0 || orderBook[s].sells.length > 0);
            if (syms.length === 0) { container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;grid-column:1/-1;">No pending orders ‚Äî place a BUY or SELL to start</div>'; return; }

            container.innerHTML = syms.map(sym => {
                const book = orderBook[sym];
                const canMatch = book.buys.length>0 && book.sells.length>0 && book.buys[0].price >= book.sells[0].price;
                return `<div class="order-book-card ${canMatch?'matchable':''}">
                    <div class="ob-symbol">${sym} ${canMatch?'<span style="color:#16a34a;font-size:0.8em;">‚ö° MATCH</span>':''}</div>
                    ${book.sells.length ? `<div class="ob-side-label sell">üî¥ SELL (${book.sells.length})</div>${book.sells.map(o=>`<div class="ob-order sell-order"><div><strong>${o.team}</strong> ¬∑ ${o.qty} @ ‚Çπ${o.price.toFixed(2)}</div><button class="ob-cancel sell" onclick="cancelOrder(${o.id},'${sym}','SELL')">‚úï</button></div>`).join('')}` : '<div class="ob-empty">No sells</div>'}
                    ${book.buys.length ? `<div class="ob-side-label buy" style="margin-top:8px;">üü¢ BUY (${book.buys.length})</div>${book.buys.map(o=>`<div class="ob-order buy-order"><div><strong>${o.team}</strong> ¬∑ ${o.qty} @ ‚Çπ${o.price.toFixed(2)}</div><button class="ob-cancel buy" onclick="cancelOrder(${o.id},'${sym}','BUY')">‚úï</button></div>`).join('')}` : '<div class="ob-empty">No buys</div>'}
                </div>`;
            }).join('');
        }

        function renderTradeLog() {
            const container = document.getElementById('tradesLogContent');
            container.innerHTML = tradeLog.slice(0,30).map(t => `<div class="trade-row">
                <div>${t.buyer}</div><div>${t.seller}</div><div>${t.symbol}</div><div>${t.qty}</div><div>‚Çπ${t.price.toFixed(2)}</div><div>${t.timestamp.toLocaleTimeString()}</div>
            </div>`).join('');
        }

        function exportTrades() {
            let csv = "data:text/csv;charset=utf-8,Buyer,Seller,Symbol,Qty,Price,Value,Time\n";
            tradeLog.forEach(t => { csv += `${t.buyer},${t.seller},${t.symbol},${t.qty},${t.price},${t.value},${t.timestamp.toISOString()}\n`; });
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `trades_session_${currentSession}.csv`; link.click();
        }

        function clearTrades() { if (confirm('Clear all?')) { tradeLog = []; initOrderBook(); renderTradeLog(); renderOrderBook(); } }

        // ==================== PRICES PANEL ====================
        function renderAdminHoldings() {
            const container = document.getElementById('adminHoldingsTable');
            if (!container) return;
            const teamNames = Object.keys(teams);
            if (teamNames.length === 0) { container.innerHTML = '<div style="color:#999;padding:15px;">No teams</div>'; return; }
            const allSymbols = [indexFund.symbol, ...stocks.map(s => s.symbol)];

            let html = '<table class="holdings-table"><thead><tr><th>Team</th>';
            allSymbols.forEach(sym => { html += `<th>${sym}</th>`; });
            html += '<th>Cash</th><th>Net Worth</th></tr></thead><tbody>';

            teamNames.forEach(name => {
                const team = teams[name];
                let nw = team.cash;
                html += `<tr><td>${name}</td>`;
                allSymbols.forEach(sym => {
                    const qty = team.holdings[sym] || 0;
                    if (sym === indexFund.symbol) nw += qty * indexFund.value;
                    else { const s = stocks.find(st => st.symbol === sym); if (s) nw += qty * s.price; }
                    html += `<td class="${qty === 0 ? 'holdings-zero' : ''}">${qty}</td>`;
                });
                html += `<td>‚Çπ${formatINR(team.cash)}</td><td style="font-weight:bold;">‚Çπ${formatINR(nw)}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderPricesPanel() {
            const panel = document.getElementById('pricesPanel');
            let html = '';
            // Index
            const ic = indexFund.value - indexFund.open;
            const ip = ((ic/indexFund.open)*100).toFixed(2);
            const iPos = ic >= 0;
            html += `<div class="price-row" style="background:#fff4e6;border:2px solid #000;">
                <div><div class="price-name">${indexFund.name}</div><div class="price-symbol">INDEX</div></div>
                <div style="text-align:right;"><div class="price-val">‚Çπ${indexFund.value.toFixed(2)}</div><div class="price-change-small ${iPos?'pos':'neg'}">${iPos?'‚ñ≤':'‚ñº'} ${iPos?'+':''}${ip}%</div></div>
            </div>`;
            // Stocks
            stocks.forEach(s => {
                const c = s.price - s.open;
                const p = ((c/s.open)*100).toFixed(2);
                const pos = c >= 0;
                html += `<div class="price-row">
                    <div><div class="price-name">${s.name}</div><div class="price-symbol">${s.symbol}</div></div>
                    <div style="text-align:right;"><div class="price-val">‚Çπ${s.price.toFixed(2)}</div><div class="price-change-small ${pos?'pos':'neg'}">${pos?'‚ñ≤':'‚ñº'} ${pos?'+':''}${p}%</div></div>
                </div>`;
            });
            panel.innerHTML = html;
        }

        // ==================== SESSION CONTROL ====================
        function showFlashNews(item) {
            const stock = stocks.find(s => s.symbol === item.company);
            const companyName = stock?.name || item.company;
            broadcastFlashNews(companyName, item.news);

            setTimeout(() => {
                if (stock) {
                    const drift = item.driftMin + Math.random() * (item.driftMax - item.driftMin);
                    const impact = (stock.price * drift) / 100;
                    const steps = Math.floor(SESSION_DURATION_MS / 2000);
                    const inc = impact / steps;
                    let step = 0;
                    const anim = setInterval(() => {
                        if (!sessionStartTime || step >= steps || (Date.now() - sessionStartTime) >= SESSION_DURATION_MS) { clearInterval(anim); return; }
                        stock.price += inc;
                        renderPricesPanel();
                        step++;
                    }, 2000);
                    allPriceAnimations.push(anim);
                    newsHistory.unshift({ company: companyName, news: item.news, time: new Date().toLocaleTimeString(), session: currentSession });
                    db.ref('newsHistory').set(newsHistory.filter(n => n.session === currentSession));
                }
            }, 2000);
        }

        function togglePause() {
            if (!sessionStartTime && !sessionPaused) return;

            if (!sessionPaused) {
                // PAUSE
                sessionPaused = true;
                sessionElapsedBeforePause += Date.now() - sessionStartTime;
                sessionStartTime = null;
                stopMarketClock();
                allPriceAnimations.forEach(clearInterval);
                allPriceAnimations = [];

                document.getElementById('pauseBtn').textContent = '‚ñ∂ Resume';
                document.getElementById('marketStatus').textContent = 'PAUSED';
                document.getElementById('marketStatus').className = 'market-status-text closing';

                broadcastStateUpdate();
            } else {
                // RESUME
                sessionPaused = false;
                sessionStartTime = Date.now() - sessionElapsedBeforePause;
                startMarketClock();

                document.getElementById('pauseBtn').textContent = '‚è∏ Pause';
                document.getElementById('marketStatus').textContent = 'MARKET OPEN';
                document.getElementById('marketStatus').className = 'market-status-text open';

                broadcastStateUpdate();
            }
        }

        function startSession() {
            if (isFlashNewsRunning) return;
            isFlashNewsRunning = true;
            sessionPaused = false;
            sessionElapsedBeforePause = 0;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('skipBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('pauseBtn').textContent = '‚è∏ Pause';
            sessionStartTime = Date.now();
            startMarketClock();

            const news = flashNewsData.filter(n => n.session === currentSession);
            currentNewsIndex = 0;
            function showNext() {
                if (currentNewsIndex < news.length) { showFlashNews(news[currentNewsIndex]); currentNewsIndex++; setTimeout(showNext, 3000); }
            }
            showNext();
            broadcastFullSync();
        }

        function skipToEnd() {
            if (!sessionStartTime && !sessionPaused) return;
            allPriceAnimations.forEach(clearInterval); allPriceAnimations = [];
            sessionStartTime = null;
            sessionPaused = false;
            sessionElapsedBeforePause = 0;

            flashNewsData.filter(n => n.session === currentSession).forEach(item => {
                const stock = stocks.find(s => s.symbol === item.company);
                if (stock) {
                    const drift = item.driftMin + Math.random() * (item.driftMax - item.driftMin);
                    stock.price += (stock.price * drift) / 100;
                    if (!newsHistory.some(h => h.company === (stocks.find(s=>s.symbol===item.company)?.name) && h.session === currentSession)) {
                        newsHistory.unshift({ company: stock.name, news: item.news, time: new Date().toLocaleTimeString(), session: currentSession });
                    }
                }
            });
            indexFund.value += (indexFund.value * indexFund.drift[currentSession]) / 100;

            document.getElementById('marketClock').textContent = '15:30';
            document.getElementById('marketStatus').textContent = 'MARKET CLOSED';
            document.getElementById('marketStatus').className = 'market-status-text closed';
            stopMarketClock();
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('skipBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = true;
            renderPricesPanel();
            broadcastStateUpdate();
            db.ref('newsHistory').set(newsHistory.filter(n => n.session === currentSession));
        }

        function nextSession() {
            currentSession++;
            if (currentSession > 3) {
                currentSession = 1;
                stocks.forEach(s => { s.price = s.open; s.priceHistory = [s.open]; });
                indexFund.value = indexFund.open; indexFund.history = [indexFund.open];
            }
            document.getElementById('sessionName').textContent = currentSession;
            document.getElementById('sessionNum').textContent = currentSession;
            isFlashNewsRunning = false; currentNewsIndex = 0;
            newsHistory = newsHistory.filter(n => n.session !== currentSession);
            allPriceAnimations.forEach(clearInterval); allPriceAnimations = [];
            initOrderBook(); renderOrderBook();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('skipBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = true;
            sessionPaused = false;
            sessionElapsedBeforePause = 0;
            resetMarketClock();
            renderPricesPanel();
            broadcastSessionReset();
        }

        function fullReset() {
            if (!confirm('‚ö†Ô∏è FULL RESET\n\nThis will:\n‚Ä¢ Reset ALL stock prices to starting values\n‚Ä¢ Reset ALL team cash and holdings\n‚Ä¢ Clear ALL trades and news\n‚Ä¢ Reset to Session 1\n‚Ä¢ Wipe Firebase state\n\nAre you sure?')) return;

            // Stop everything
            allPriceAnimations.forEach(clearInterval);
            allPriceAnimations = [];
            stopMarketClock();
            sessionStartTime = null;
            sessionPaused = false;
            sessionElapsedBeforePause = 0;
            isFlashNewsRunning = false;
            currentNewsIndex = 0;
            currentSession = 1;

            // Reset stocks
            const defaultPrices = { ADANIPORTS: 850, LT: 3400, JSWSTEEL: 820, ONGC: 260, TCS: 4100, TITAN: 3600, CEATLTD: 2800, SBIN: 720 };
            stocks.forEach(s => {
                s.price = defaultPrices[s.symbol] || s.open;
                s.open = s.price;
                s.priceHistory = [s.price];
            });

            // Reset index
            indexFund.value = 21000;
            indexFund.open = 21000;
            indexFund.history = [21000];

            // Reset teams to defaults
            teams = {
                'Team A': { cash: 500000, holdings: {} },
                'Team B': { cash: 500000, holdings: {} },
                'Team C': { cash: 500000, holdings: {} },
                'Team D': { cash: 500000, holdings: {} },
                'Team E': { cash: 500000, holdings: {} }
            };
            initializeTeamHoldings();

            // Clear logs
            tradeLog = [];
            newsHistory = [];
            initOrderBook();

            // Reset UI
            document.getElementById('sessionName').textContent = '1';
            document.getElementById('sessionNum').textContent = '1';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('skipBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = true;
            resetMarketClock();

            // Re-render
            renderPricesPanel();
            renderTradeLog();
            renderOrderBook();
            renderAdminHoldings();

            // Wipe Firebase room and push fresh state
            fbDb.ref('rooms/' + roomKey).set(null).then(() => {
                broadcastFullSync();
                alert('‚úÖ Full reset complete. Everything is back to defaults.');
            });
        }

        function startMarketClock() {
            marketClockInterval = setInterval(() => {
                if (!sessionStartTime) return;
                const elapsed = Date.now() - sessionStartTime;
                const progress = elapsed / SESSION_DURATION_MS;
                const minutes = MARKET_START_TIME.minutes + Math.floor(progress * 375);
                const hours = MARKET_START_TIME.hours + Math.floor(minutes / 60);
                const mins = minutes % 60;
                document.getElementById('marketClock').textContent = `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}`;
                const status = document.getElementById('marketStatus');
                if (progress < 0.9) { status.textContent = 'MARKET OPEN'; status.className = 'market-status-text open'; }
                else if (progress < 1) { status.textContent = 'CLOSING SOON'; status.className = 'market-status-text closing'; }
                else { status.textContent = 'MARKET CLOSED'; status.className = 'market-status-text closed'; stopMarketClock(); document.getElementById('nextBtn').disabled = false; document.getElementById('skipBtn').disabled = true; document.getElementById('pauseBtn').disabled = true; }
            }, 100);
            setTimeout(() => stopMarketClock(), SESSION_DURATION_MS);
        }
        function stopMarketClock() { if (marketClockInterval) { clearInterval(marketClockInterval); marketClockInterval = null; } }
        function resetMarketClock() { sessionStartTime = null; document.getElementById('marketClock').textContent = '09:15'; document.getElementById('marketStatus').textContent = 'MARKET OPEN'; document.getElementById('marketStatus').className = 'market-status-text open'; }

        // Random fluctuations
        setInterval(() => {
            if (!sessionStartTime || sessionPaused || (Date.now() - sessionStartTime) >= SESSION_DURATION_MS) return;
            stocks.forEach(stock => {
                stock.price += stock.price * (Math.random() - 0.5) * 0.003;
                if (stock.price < stock.open * 0.5) stock.price = stock.open * 0.5;
            });
            indexFund.value += indexFund.value * (Math.random() - 0.5) * 0.002;
            renderPricesPanel();
            renderAdminHoldings();
        }, 3000);

        // ==================== INIT ====================
        initOrderBook();
        initializeTeamHoldings();
        renderPricesPanel();
        renderTradeLog();
        renderOrderBook();
        renderAdminHoldings();
    </script>
</body>
</html>
