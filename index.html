<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMPORIO 2025 - Joseph's Stock Exchange</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 10px;
            font-size: 14px;
        }

        body.presentation-mode {
            font-size: 18px;
            padding: 5px;
        }

        body.presentation-mode .layout {
            gap: 10px;
        }

        body.presentation-mode .stock-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        body.presentation-mode .stock-card {
            padding: 18px;
        }

        body.presentation-mode .current-price {
            font-size: 2em;
        }

        body.presentation-mode .company-name {
            font-size: 1.3em;
        }

        body.presentation-mode .header h1 {
            font-size: 1.4em;
        }

        .layout {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            gap: 15px;
            max-width: 100%;
            margin: 0 auto;
            height: calc(100vh - 20px);
        }

        /* ADMIN BAR */
        .admin-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            padding: 12px 20px;
            z-index: 10000;
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid #404040;
        }

        .admin-bar.hidden {
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.admin-visible {
            padding-top: 50px;
        }

        .admin-controls {
            display: flex;
            gap: 8px;
        }

        .admin-btn {
            padding: 8px 18px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            letter-spacing: 0.3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .admin-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .admin-btn:hover::before {
            left: 100%;
        }

        .admin-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .admin-btn:active {
            transform: translateY(0);
        }

        .admin-btn.active {
            background: #4ade80;
            border-color: #4ade80;
        }

        .lock-btn {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .lock-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .presentation-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .presentation-toggle label {
            font-size: 0.9em;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .presentation-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border: 3px solid #000000;
            padding: 35px;
            max-width: 1200px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin: 20px;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #000000;
        }

        .modal-title {
            font-size: 2em;
            font-weight: bold;
            letter-spacing: -0.5px;
        }

        .close-btn {
            background: #000000;
            color: #ffffff;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #333333;
            transform: scale(1.05);
        }

        .close-btn:active {
            transform: scale(0.98);
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            border-bottom: 2px solid #e5e5e5;
            overflow-x: auto;
        }

        .tab {
            padding: 14px 28px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            letter-spacing: 0.3px;
            color: #666;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            white-space: nowrap;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background: #000000;
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab:hover {
            color: #000000;
            background: rgba(0, 0, 0, 0.02);
        }

        .tab.active {
            color: #000000;
            background: transparent;
        }

        .tab.active::after {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-section {
            margin-bottom: 30px;
            border: 2px solid #e5e5e5;
            padding: 25px;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .config-section:hover {
            border-color: #d0d0d0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .config-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #000000;
            letter-spacing: -0.3px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-item label {
            font-weight: bold;
            font-size: 0.9em;
        }

        .config-item input,
        .config-item textarea,
        .config-item select {
            padding: 10px 12px;
            border: 2px solid #e5e5e5;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .config-item input:focus,
        .config-item textarea:focus,
        .config-item select:focus {
            outline: none;
            border-color: #000000;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .config-item input:hover,
        .config-item textarea:hover,
        .config-item select:hover {
            border-color: #d0d0d0;
        }

        .config-item textarea {
            min-height: 80px;
            font-family: inherit;
        }

        .drift-grid {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr);
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .drift-grid.header {
            font-weight: bold;
            background: #000000;
            color: #ffffff;
            padding: 10px;
        }

        .drift-grid input {
            padding: 6px;
            border: 1px solid #000000;
        }

        .btn-save {
            padding: 16px 32px;
            background: #000000;
            color: #ffffff;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-save::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-save:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-save:hover {
            background: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-save:active {
            transform: translateY(0);
        }

        .btn-add {
            padding: 14px 28px;
            background: linear-gradient(135deg, #000000 0%, #2d2d2d 100%);
            color: #ffffff;
            border: 2px solid #000000;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-add:hover {
            background: linear-gradient(135deg, #1a1a1a 0%, #404040 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .btn-add:active {
            transform: translateY(0);
        }

        .btn-remove {
            padding: 10px 20px;
            background: #ef4444;
            color: #ffffff;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-remove:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .btn-remove:active {
            transform: scale(0.98);
        }

        /* LEADERBOARD */
        .leaderboard {
            background: #ffffff;
            border: 2px solid #000000;
            padding: 15px;
            overflow-y: auto;
        }

        .leaderboard-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .team-card {
            background: #f9f9f9;
            border: 2px solid #000000;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .team-card.rank-1 {
            background: #fff4e6;
            border: 3px solid #000000;
        }

        @keyframes slideInRank {
            0% {
                transform: translateX(-20px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .team-rank {
            font-size: 1.5em;
            font-weight: bold;
            float: right;
        }

        .team-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .team-stats {
            font-size: 0.85em;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        .team-networth {
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #000000;
        }

        /* MAIN CONTENT */
        .main-content {
            overflow-y: auto;
        }

        .header {
            background: #000000;
            color: #ffffff;
            padding: 8px 20px;
            text-align: center;
            margin-bottom: 10px;
            border: 2px solid #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header h1 {
            font-size: 1.2em;
            margin-bottom: 0;
        }

        .header p {
            font-size: 0.85em;
            opacity: 0.7;
        }

        .session-info {
            background: #000000;
            color: #ffffff;
            padding: 12px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid #000000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .session-label, .market-clock, .market-status {
            font-size: 1.2em;
            font-weight: bold;
        }

        .market-status.open { color: #4ade80; }
        .market-status.closing { color: #fbbf24; }
        .market-status.closed { color: #f87171; }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            font-size: 1.1em;
            border: 2px solid #000000;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: #000000;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #1a1a1a;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #666666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: #ffffff;
            color: #000000;
        }

        .btn-success:hover {
            background: #f0f0f0;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .btn-success:active {
            transform: translateY(-1px);
        }

        /* TRADE ENTRY */
        .trade-section {
            background: #ffffff;
            border: 2px solid #000000;
            padding: 15px;
            margin-bottom: 15px;
        }

        .trade-section.collapsed .trade-content {
            display: none;
        }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .trade-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .toggle-btn {
            padding: 8px 16px;
            background: #000000;
            color: #ffffff;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .trade-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f5f5f5;
            border: 1px solid #000000;
        }

        .trade-form label {
            font-weight: bold;
            font-size: 0.85em;
            display: block;
            margin-bottom: 4px;
        }

        .trade-form select,
        .trade-form input {
            padding: 6px;
            border: 1px solid #000000;
            font-size: 0.9em;
            width: 100%;
        }

        .trade-form button {
            padding: 8px 16px;
            background: #000000;
            color: #ffffff;
            border: none;
            cursor: pointer;
            font-weight: bold;
            align-self: end;
        }

        .trades-log {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #000000;
            background: #fafafa;
        }

        .trade-row {
            display: grid;
            grid-template-columns: 100px 100px 80px 70px 100px 100px;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #e5e5e5;
            font-size: 0.85em;
            font-family: 'Courier New', monospace;
            background: #fafafa;
        }

        .trade-row.header {
            background: #000000;
            color: #ffffff;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        /* STOCK GRID */
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stock-card {
            background: #ffffff;
            border: 2px solid #000000;
            padding: 15px;
            box-shadow: 4px 4px 0 #000000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stock-card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000000;
        }

        .stock-card.flash {
            animation: flashCard 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes flashCard {
            0%, 100% { 
                background: #ffffff;
                transform: scale(1);
            }
            50% { 
                background: #f0f0f0;
                transform: scale(1.02);
            }
        }

        .mini-chart-container {
            margin: 10px 0;
            height: 60px;
            position: relative;
            border: 1px solid #e5e5e5;
            background: #fafafa;
        }

        .mini-chart {
            width: 100%;
            height: 100%;
        }

        .company-name {
            font-size: 1.2em;
            font-weight: bold;
        }

        .stock-symbol {
            font-size: 0.85em;
            color: #666;
        }

        .current-price {
            font-size: 1.8em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 8px 0;
        }

        .price-change {
            font-size: 1em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .price-change.positive { color: #16a34a; }
        .price-change.negative { color: #dc2626; }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e5e5;
            font-size: 0.85em;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* NEWS SIDEBAR */
        .news-sidebar {
            background: #ffffff;
            border: 2px solid #000000;
            padding: 15px;
            overflow-y: auto;
        }

        .news-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .news-item {
            background: #f9f9f9;
            border: 1px solid #000000;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.85em;
        }

        .news-company {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 6px;
        }

        .news-text {
            line-height: 1.5;
            margin-bottom: 6px;
        }

        .news-time {
            font-size: 0.8em;
            color: #666;
        }

        /* FLASH NEWS */
        .flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeInOverlay 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInOverlay {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .flash-overlay.show {
            display: flex;
        }

        .flash-news {
            background: #ffffff;
            border: 4px solid #000000;
            padding: 40px;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideUpNews 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUpNews {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .flash-company {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }

        .flash-text {
            font-size: 1.2em;
            line-height: 1.8;
        }

        /* INDEX FUND CARD */
        .index-card {
            background: #fff4e6;
            border: 3px solid #000000;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 4px 4px 0 #000000;
        }
        /* TEAM HOLDINGS TABLE */
        .team-holdings-section {
            background: #ffffff;
            border: 2px solid #000000;
            padding: 15px;
            margin-top: 15px;
        }

        .holdings-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            font-family: 'Courier New', monospace;
        }

        .holdings-table th {
            background: #000000;
            color: #ffffff;
            padding: 8px 10px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .holdings-table th:first-child {
            text-align: left;
        }

        .holdings-table td {
            padding: 7px 10px;
            text-align: center;
            border-bottom: 1px solid #e5e5e5;
        }

        .holdings-table td:first-child {
            text-align: left;
            font-weight: bold;
        }

        .holdings-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .holdings-table tr:hover {
            background: #f0f0f0;
        }

        .holdings-zero {
            color: #ccc;
        }
    </style>
</head>
<body class="admin-visible">
    <!-- Admin Bar -->
    <div class="admin-bar" id="adminBar">
        <div class="admin-controls">
            <button class="admin-btn" onclick="openAdminConsole('teams')">Teams</button>
            <button class="admin-btn" onclick="openAdminConsole('drift')">Drift</button>
            <button class="admin-btn" onclick="openAdminConsole('news')">News</button>
            <button class="admin-btn" onclick="openAdminConsole('index')">Index Fund</button>
            <button class="admin-btn" onclick="openAdminConsole('engine')">Engine</button>
        </div>
        <div class="admin-controls">
            <div class="presentation-toggle">
                <label>Presentation Mode</label>
                <input type="checkbox" id="presentationMode" onchange="togglePresentationMode()">
            </div>
            <button class="admin-btn lock-btn" onclick="toggleAdminBar()">Lock & Hide</button>
        </div>
    </div>

    <!-- Admin Console Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Admin Console</div>
                <button class="close-btn" onclick="closeAdminConsole()">‚úï Close</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('teams')">Teams</div>
                <div class="tab" onclick="switchTab('drift')">Price Drift</div>
                <div class="tab" onclick="switchTab('news')">Flash News</div>
                <div class="tab" onclick="switchTab('index')">Index Fund</div>
                <div class="tab" onclick="switchTab('engine')">Market Engine</div>
            </div>

            <!-- TEAMS TAB -->
            <div class="tab-content active" id="tab-teams">
                <button class="btn-add" onclick="addTeam()">+ Add New Team</button>
                <div id="teamConfigContainer"></div>
                <button class="btn-save" onclick="saveTeamConfig()">üíæ Save Teams</button>
            </div>

            <!-- DRIFT TAB -->
            <div class="tab-content" id="tab-drift">
                <div class="config-section">
                    <div class="config-header">Session 1 - Drift Ranges</div>
                    <div class="drift-grid header">
                        <div>Stock</div>
                        <div>Min %</div>
                        <div>Max %</div>
                        <div>Mid %</div>
                    </div>
                    <div id="drift-session-1"></div>
                </div>
                
                <div class="config-section">
                    <div class="config-header">Session 2 - Drift Ranges</div>
                    <div class="drift-grid header">
                        <div>Stock</div>
                        <div>Min %</div>
                        <div>Max %</div>
                        <div>Mid %</div>
                    </div>
                    <div id="drift-session-2"></div>
                </div>
                
                <div class="config-section">
                    <div class="config-header">Session 3 - Drift Ranges</div>
                    <div class="drift-grid header">
                        <div>Stock</div>
                        <div>Min %</div>
                        <div>Max %</div>
                        <div>Mid %</div>
                    </div>
                    <div id="drift-session-3"></div>
                </div>
                
                <button class="btn-save" onclick="saveDriftConfig()">üíæ Save Drift Config</button>
            </div>

            <!-- NEWS TAB -->
            <div class="tab-content" id="tab-news">
                <div class="config-section">
                    <div class="config-header">Session 1 - Flash News</div>
                    <div id="news-session-1"></div>
                </div>
                
                <div class="config-section">
                    <div class="config-header">Session 2 - Flash News</div>
                    <div id="news-session-2"></div>
                </div>
                
                <div class="config-section">
                    <div class="config-header">Session 3 - Flash News</div>
                    <div id="news-session-3"></div>
                </div>
                
                <button class="btn-save" onclick="saveNewsConfig()">üíæ Save News</button>
            </div>

            <!-- INDEX FUND TAB -->
            <div class="tab-content" id="tab-index">
                <div class="config-section">
                    <div class="config-header">Index Fund Configuration</div>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Index Name</label>
                            <input type="text" id="indexName" value="NIFTY 50">
                        </div>
                        <div class="config-item">
                            <label>Starting Value</label>
                            <input type="number" id="indexStart" value="21000">
                        </div>
                    </div>
                    
                    <div class="config-header" style="margin-top: 20px;">Session Drift</div>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Session 1 Drift (%)</label>
                            <input type="number" id="indexDrift1" value="0.5" step="0.1">
                        </div>
                        <div class="config-item">
                            <label>Session 2 Drift (%)</label>
                            <input type="number" id="indexDrift2" value="-0.3" step="0.1">
                        </div>
                        <div class="config-item">
                            <label>Session 3 Drift (%)</label>
                            <input type="number" id="indexDrift3" value="0.8" step="0.1">
                        </div>
                    </div>
                </div>
                <button class="btn-save" onclick="saveIndexConfig()">üíæ Save Index Fund</button>
            </div>

            <!-- MARKET ENGINE TAB -->
            <div class="tab-content" id="tab-engine">
                <div class="config-section">
                    <div class="config-header">Market Engine Settings</div>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Engine Mode</label>
                            <select id="engineEnabled" onchange="toggleMarketEngine()">
                                <option value="false">Disabled (Simple Mode)</option>
                                <option value="true">Built-in Engine</option>
                                <option value="external" selected>Full Market Engine (Embedded)</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <label>Depth Factor</label>
                            <input type="number" id="engineDepth" value="0.02" step="0.001">
                        </div>
                        <div class="config-item">
                            <label>Impact Clamp (%)</label>
                            <input type="number" id="engineClamp" value="2.5" step="0.1">
                        </div>
                    </div>
                    

                    <div class="config-header" style="margin-top: 20px;">Liquidity Coefficients (K)</div>
                    <p style="margin-bottom: 15px; color: #666;">Higher K = More price movement per trade. Lower K = More stable (liquid) stock.</p>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>NIFTY50 (K)</label>
                            <input type="number" id="engineK-NIFTY50" value="0.50" step="0.05">
                        </div>
                        <div class="config-item">
                            <label>ADANIPORTS (K)</label>
                            <input type="number" id="engineK-ADANIPORTS" value="1.05" step="0.05">
                        </div>
                        <div class="config-item">
                            <label>LT (K)</label>
                            <input type="number" id="engineK-LT" value="1.00" step="0.05">
                        </div>
                        <div class="config-item">
                            <label>JSWSTEEL (K)</label>
                            <input type="number" id="engineK-JSWSTEEL" value="0.85" step="0.05">
                        </div>
                        <div class="config-item">
                            <label>ONGC (K)</label>
                            <input type="number" id="engineK-ONGC" value="0.75" step="0.05">
                        </div>
                        <div class="config-item">
                            <label>TCS (K)</label>
                            <input type="number" id="engineK-TCS" value="1.15" step="0.05">
                        </div>
                        <div class="config-item">
                            <label>TITAN (K)</label>
                            <input type="number" id="engineK-TITAN" value="1.05" step="0.05">
                        </div>
                        <div class="config-item">
                            <label>CEAT (K)</label>
                            <input type="number" id="engineK-CEATLTD" value="1.60" step="0.05">
                        </div>
                        <div class="config-item">
                            <label>SBI (K)</label>
                            <input type="number" id="engineK-SBIN" value="0.70" step="0.05">
                        </div>
                    </div>
                </div>
                <button class="btn-save" onclick="saveEngineConfig()">üíæ Save Engine Config</button>
            </div>
        </div>
    </div>

    <div class="layout">
        <!-- LEADERBOARD -->
        <div class="leaderboard">
            <div class="leaderboard-title">üèÜ Leaderboard</div>
            <div id="indexFundCard"></div>
            <div id="leaderboardContent"></div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="header">
                <h1>EMPORIO 2025</h1>
                <span style="opacity:0.4;">|</span>
                <p>Joseph's Stock Exchange</p>
            </div>

            <div class="session-info">
                <div class="session-label">Session: <span id="sessionName">1</span></div>
                <div class="market-clock" id="marketClock">09:15</div>
                <div class="market-status open" id="marketStatus">MARKET OPEN</div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startSession()">Start Session</button>
                <button class="btn btn-primary" id="skipBtn" onclick="skipToEnd()" disabled>‚è≠Ô∏è Skip</button>
                <button class="btn btn-success" id="nextBtn" onclick="nextSession()" disabled>Next Session</button>
            </div>

            <div class="trade-section" id="tradeSection">
                <div class="trade-header">
                    <div class="trade-title">üìä Trade Entry</div>
                    <button class="toggle-btn" onclick="toggleTrades()">
                        <span id="toggleTradeText">‚ñº</span>
                    </button>
                </div>
                <div class="trade-content">
                    <div class="trade-form">
                        <div>
                            <label>Team</label>
                            <select id="tradeTeam"></select>
                        </div>
                        <div>
                            <label>Stock</label>
                            <select id="tradeStock"></select>
                        </div>
                        <div>
                            <label>Side</label>
                            <select id="tradeSide">
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div>
                            <label>Qty</label>
                            <input type="number" id="tradeQty" placeholder="100" min="1">
                        </div>
                        <div>
                            <label>Price (‚Çπ)</label>
                            <input type="number" id="tradePrice" placeholder="850" step="0.01">
                        </div>
                        <div>
                            <button onclick="executeTrade()">Place Order</button>
                        </div>
                    </div>
                    
                    <!-- Order Book -->
                    <div style="margin: 20px 0;">
                        <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #000;">üìã Pending Orders</div>
                        <div id="orderBookContent" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- Executed Trades -->
                    <div style="font-weight: bold; font-size: 1.1em; margin: 15px 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #000;">‚úÖ Executed Trades</div>
                    <div class="trades-log">
                        <div class="trade-row header">
                            <div>Buyer</div>
                            <div>Seller</div>
                            <div>Stock</div>
                            <div>Qty</div>
                            <div>Price</div>
                            <div>Time</div>
                        </div>
                        <div id="tradesLogContent"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-success" onclick="exportTrades()">üì• Export</button>
                        <button class="btn" onclick="clearTrades()">üóëÔ∏è Clear</button>
                    </div>
                </div>
            </div>

            <div class="stock-grid" id="stockGrid"></div>

            <!-- Team Holdings Table -->
            <div class="team-holdings-section" id="teamHoldingsSection">
                <div class="holdings-title">üìã Team Holdings</div>
                <div id="teamHoldingsTable"></div>
            </div>
        </div>

        <!-- NEWS SIDEBAR -->
        <div class="news-sidebar">
            <div class="news-title">üì∞ News Feed</div>
            <div id="newsHistory"></div>
        </div>
    </div>

    <!-- Flash News -->
    <div class="flash-overlay" id="flashOverlay">
        <div class="flash-news">
            <div class="flash-company" id="flashCompany"></div>
            <div class="flash-text" id="flashText"></div>
        </div>
    </div>

    <script>
        // ==================== EMBEDDED MARKET ENGINE ====================
        window.MarketEngine = {
            stockConfig: {
                ADANIPORTS: { startPrice: 850.00, dailyVolume: 2_500_000, K: 1.05 },
                LT: { startPrice: 3400.00, dailyVolume: 3_200_000, K: 1.00 },
                JSWSTEEL: { startPrice: 820.00, dailyVolume: 8_500_000, K: 0.85 },
                ONGC: { startPrice: 260.00, dailyVolume: 12_800_000, K: 0.75 },
                TCS: { startPrice: 4100.00, dailyVolume: 1_800_000, K: 1.15 },
                TITAN: { startPrice: 3600.00, dailyVolume: 2_800_000, K: 1.05 },
                CEATLTD: { startPrice: 2800.00, dailyVolume: 680_000, K: 1.60 },
                SBIN: { startPrice: 720.00, dailyVolume: 18_500_000, K: 0.70 },
                NIFTY50: { startPrice: 21000.00, dailyVolume: 50_000_000, K: 0.50 }
            },
            params: {
                depthFactor: 0.02,
                perTradeImpactClamp: 0.025
            },
            calculateImpact(symbol, side, qty, price) {
                const config = this.stockConfig[symbol];
                if (!config) return 0;
                const direction = side === 'BUY' ? 1 : -1;
                const tradeValue = qty * price;
                const liquidityValue = (config.dailyVolume * config.startPrice) * this.params.depthFactor;
                const impact = direction * config.K * Math.sqrt(tradeValue / liquidityValue);
                return Math.max(-this.params.perTradeImpactClamp, Math.min(this.params.perTradeImpactClamp, impact));
            }
        };

        // ==================== DATA MODELS ====================
        
        let teams = {
            'Team A': { cash: 500000, holdings: {} },
            'Team B': { cash: 500000, holdings: {} },
            'Team C': { cash: 500000, holdings: {} },
            'Team D': { cash: 500000, holdings: {} },
            'Team E': { cash: 500000, holdings: {} }
        };

        const stocks = [
            { name: 'Adani Ports', symbol: 'ADANIPORTS', price: 850.00, open: 850.00, volume: '2.5M', priceHistory: [850.00] },
            { name: 'L&T', symbol: 'LT', price: 3400.00, open: 3400.00, volume: '3.2M', priceHistory: [3400.00] },
            { name: 'JSW Steel', symbol: 'JSWSTEEL', price: 820.00, open: 820.00, volume: '8.5M', priceHistory: [820.00] },
            { name: 'ONGC', symbol: 'ONGC', price: 260.00, open: 260.00, volume: '12.8M', priceHistory: [260.00] },
            { name: 'TCS', symbol: 'TCS', price: 4100.00, open: 4100.00, volume: '1.8M', priceHistory: [4100.00] },
            { name: 'Titan', symbol: 'TITAN', price: 3600.00, open: 3600.00, volume: '2.8M', priceHistory: [3600.00] },
            { name: 'CEAT', symbol: 'CEATLTD', price: 2800.00, open: 2800.00, volume: '680K', priceHistory: [2800.00] },
            { name: 'State Bank of India', symbol: 'SBIN', price: 720.00, open: 720.00, volume: '18.5M', priceHistory: [720.00] }
        ];

        let indexFund = {
            name: 'NIFTY 50',
            symbol: 'NIFTY50',
            value: 21000,
            open: 21000,
            drift: { 1: 0.5, 2: -0.3, 3: 0.8 },
            history: [21000],
            volume: '500M'
        };

        // Market Engine Configuration
        const marketEngine = {
            enabled: 'external', // Full Market Engine enabled by default
            config: {
                ADANIPORTS: { dailyVolume: 2500000, K: 1.05 },
                LT: { dailyVolume: 3200000, K: 1.00 },
                JSWSTEEL: { dailyVolume: 8500000, K: 0.85 },
                ONGC: { dailyVolume: 12800000, K: 0.75 },
                TCS: { dailyVolume: 1800000, K: 1.15 },
                TITAN: { dailyVolume: 2800000, K: 1.05 },
                CEATLTD: { dailyVolume: 680000, K: 1.60 },
                SBIN: { dailyVolume: 18500000, K: 0.70 },
                NIFTY50: { dailyVolume: 50000000, K: 0.50 }
            },
            params: {
                depthFactor: 0.02,
                impactClamp: 0.025
            }
        };

        let flashNewsData = [
            { session: 1, company: 'ADANIPORTS', news: 'Adani Ports reported Q3 revenue of ‚Çπ7,980 crore (+13% YoY) with EBITDA margin at 50.1%, while net debt rose to ‚Çπ51,900 crore following ‚Çπ3,000 crore capex during the quarter.', driftMin: -0.6, driftMax: 0.8, driftMid: 0.1 },
            { session: 1, company: 'LT', news: 'L&T recorded order inflows of ‚Çπ70,200 crore, taking its backlog to ‚Çπ4.66 lakh crore, though operating cash flow remained negative due to ‚Çπ7,600 crore rise in receivables.', driftMin: -0.8, driftMax: 0.9, driftMid: 0.1 },
            { session: 1, company: 'TITAN', news: 'Titan posted 15% revenue growth to ‚Çπ11,150 crore with EBITDA margin at 12.8%, while inventory days increased to 159 from 146 last quarter.', driftMin: -0.7, driftMax: 1.0, driftMid: 0.2 },
            { session: 1, company: 'JSWSTEEL', news: 'JSW Steel reported EBITDA of ‚Çπ6,080 crore (margin 18.9%), down 120 bps QoQ, even as net debt declined marginally to ‚Çπ62,300 crore.', driftMin: -1.6, driftMax: -0.4, driftMid: -1.0 },
            { session: 1, company: 'ONGC', news: 'ONGC realized $79/bbl crude with net profit up 8% YoY, though production volumes fell 2.5% and quarterly capex stood at ‚Çπ8,500 crore.', driftMin: -1.0, driftMax: 0.6, driftMid: -0.2 },
            { session: 1, company: 'TCS', news: 'TCS delivered ‚Çπ59,400 crore revenue (+8% YoY) with operating margin steady at 24.2%, while employee costs rose 11% year-on-year.', driftMin: 0.6, driftMax: 1.8, driftMid: 1.2 },
            { session: 1, company: 'CEATLTD', news: 'CEAT revenue grew 9% YoY to ‚Çπ3,040 crore, but EBITDA margin contracted to 11.2% as finance costs rose 18%.', driftMin: -2.8, driftMax: -1.2, driftMid: -2.0 },
            { session: 1, company: 'SBIN', news: 'SBI reported NII of ‚Çπ41,500 crore (+17% YoY) with NIM at 3.42%, while unsecured retail advances grew 16% year-on-year.', driftMin: 0.7, driftMax: 1.9, driftMid: 1.3 },
            { session: 2, company: 'ADANIPORTS', news: 'The company approved ‚Çπ9,600 crore additional capex, projecting debt-to-EBITDA near 3.3x while maintaining margin guidance above 49%.', driftMin: -2.6, driftMax: -1.0, driftMid: -1.8 },
            { session: 2, company: 'LT', news: 'Net profit rose 20% to ‚Çπ3,460 crore including ‚Çπ610 crore exceptional gains, while working capital cycle extended to 118 days.', driftMin: -1.2, driftMax: 0.8, driftMid: -0.2 },
            { session: 2, company: 'TITAN', news: 'Premium segment revenue rose 23% YoY, lifting EBITDA to ‚Çπ1,470 crore, though operating cash flow declined 15% sequentially.', driftMin: 0.4, driftMax: 1.6, driftMid: 1.0 },
            { session: 2, company: 'JSWSTEEL', news: 'JSW Steel approved ‚Çπ8,000 crore expansion capex as interest expense increased 15% YoY to ‚Çπ1,270 crore.', driftMin: -2.2, driftMax: -0.8, driftMid: -1.5 },
            { session: 2, company: 'ONGC', news: 'ONGC declared ‚Çπ7/share interim dividend despite flat internal accruals and unchanged production guidance.', driftMin: -1.8, driftMax: -0.6, driftMid: -1.2 },
            { session: 2, company: 'TCS', news: 'TCS trimmed margin outlook by 40 bps to 23.8% while maintaining revenue growth guidance near 8%.', driftMin: -2.4, driftMax: -0.9, driftMid: -1.6 },
            { session: 2, company: 'CEATLTD', news: 'CEAT refinanced ‚Çπ1,200 crore debt at 8.2% average cost, while domestic volumes declined 2% sequentially.', driftMin: -1.0, driftMax: 0.6, driftMid: -0.2 },
            { session: 2, company: 'SBIN', news: 'Cost-to-income ratio rose to 52.3%, while SME slippages stood at ‚Çπ4,100 crore during the quarter.', driftMin: -2.0, driftMax: -0.7, driftMid: -1.3 },
            { session: 3, company: 'ADANIPORTS', news: 'EBITDA margin held at 50.3%, though interest expense rose 21% YoY to ‚Çπ1,920 crore, moderating ROCE to 16.2%.', driftMin: -1.8, driftMax: -0.6, driftMid: -1.2 },
            { session: 3, company: 'LT', news: 'Execution revenue grew 12% YoY, but receivables rose to ‚Çπ68,400 crore, keeping free cash flow under pressure.', driftMin: -3.0, driftMax: -1.2, driftMid: -2.1 },
            { session: 3, company: 'TITAN', news: 'EBITDA margin remained near 13%, while inventory turnover declined to 2.3x and operating cash flow fell 17% sequentially.', driftMin: -2.8, driftMax: -1.0, driftMid: -1.9 },
            { session: 3, company: 'JSWSTEEL', news: 'Net debt reduced to ‚Çπ60,850 crore, even as export realizations softened 3% sequentially.', driftMin: 0.4, driftMax: 1.6, driftMid: 1.0 },
            { session: 3, company: 'ONGC', news: 'Reserve replacement ratio stood at 0.94 while dividend payout remained above 45% of profit.', driftMin: -2.2, driftMax: -0.8, driftMid: -1.5 },
            { session: 3, company: 'TCS', news: 'Deal wins stood at $9.7 billion for the quarter, though revenue per employee declined 2.6% sequentially.', driftMin: -2.6, driftMax: -1.0, driftMid: -1.8 },
            { session: 3, company: 'CEATLTD', news: 'EBITDA margin improved to 11.8%, while working capital days increased to 64 from 58.', driftMin: -0.8, driftMax: 0.8, driftMid: 0.0 },
            { session: 3, company: 'SBIN', news: 'Loan growth reached 19% YoY, with provision coverage improving to 77% despite treasury MTM losses of ‚Çπ1,700 crore.', driftMin: 0.3, driftMax: 1.3, driftMid: 0.8 }
        ];

        let currentSession = 1;
        let sessionStartTime = null;
        let marketClockInterval = null;
        let allPriceAnimations = [];
        let tradeLog = [];
        let newsHistory = [];
        let isFlashNewsRunning = false;
        let currentNewsIndex = 0;
        const SESSION_DURATION_MS = 15 * 60 * 1000;
        const MARKET_START_TIME = { hours: 9, minutes: 15 };

        // Order Book System
        let orderBook = {}; // { symbol: { buys: [], sells: [] } }
        let orderIdCounter = 1;

        function initOrderBook() {
            stocks.forEach(s => {
                orderBook[s.symbol] = { buys: [], sells: [] };
            });
            orderBook['NIFTY50'] = { buys: [], sells: [] };
        }

        // Indian number formatting (Lakhs/Crores)
        function formatINR(num) {
            const numStr = Math.round(num).toString();
            const lastThree = numStr.substring(numStr.length - 3);
            const otherNumbers = numStr.substring(0, numStr.length - 3);
            if (otherNumbers !== '') {
                return otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + "," + lastThree;
            }
            return lastThree;
        }

        // ==================== ADMIN FUNCTIONS ====================

        function toggleAdminBar() {
            const bar = document.getElementById('adminBar');
            bar.classList.toggle('hidden');
            document.body.classList.toggle('admin-visible');
        }

        function togglePresentationMode() {
            document.body.classList.toggle('presentation-mode', document.getElementById('presentationMode').checked);
        }

        function openAdminConsole(tab) {
            document.getElementById('adminModal').classList.add('show');
            switchTab(tab);
        }

        function closeAdminConsole() {
            document.getElementById('adminModal').classList.remove('show');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            const tabIndex = ['teams','drift','news','index','engine'].indexOf(tabName) + 1;
            const tab = document.querySelector(`.tab:nth-child(${tabIndex})`);
            if (tab) tab.classList.add('active');
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'teams') renderTeamConfig();
            if (tabName === 'drift') renderDriftConfig();
            if (tabName === 'news') renderNewsConfig();
        }

        // TEAM CONFIG
        function renderTeamConfig() {
            const container = document.getElementById('teamConfigContainer');
            container.innerHTML = '';

            Object.entries(teams).forEach(([name, data], idx) => {
                const section = document.createElement('div');
                section.className = 'config-section';
                
                // Header row
                const header = document.createElement('div');
                header.style = 'display: grid; grid-template-columns: 200px 150px 1fr auto; gap: 10px; margin-bottom: 15px; align-items: center;';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = name;
                nameInput.id = `team-name-${idx}`;
                nameInput.placeholder = 'Team Name';
                nameInput.style = 'padding: 8px; border: 2px solid #000;';
                
                const cashInput = document.createElement('input');
                cashInput.type = 'number';
                cashInput.value = data.cash;
                cashInput.id = `team-cash-${idx}`;
                cashInput.placeholder = 'Cash';
                cashInput.style = 'padding: 8px; border: 2px solid #000;';
                
                const holdingsLabel = document.createElement('div');
                holdingsLabel.style.fontWeight = 'bold';
                holdingsLabel.textContent = 'Holdings:';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove';
                removeBtn.textContent = 'Remove';
                removeBtn.setAttribute('data-team', name);
                removeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const teamName = this.getAttribute('data-team');
                    removeTeam(teamName);
                });
                
                header.appendChild(nameInput);
                header.appendChild(cashInput);
                header.appendChild(holdingsLabel);
                header.appendChild(removeBtn);
                
                // Holdings grid
                const holdingsGrid = document.createElement('div');
                holdingsGrid.style = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;';
                
                // NIFTY50
                const niftyDiv = document.createElement('div');
                niftyDiv.style = 'display: flex; flex-direction: column; gap: 4px;';
                const niftyLabel = document.createElement('label');
                niftyLabel.style = 'font-size: 0.85em; font-weight: bold;';
                niftyLabel.textContent = 'NIFTY50';
                const niftyInput = document.createElement('input');
                niftyInput.type = 'number';
                niftyInput.value = data.holdings['NIFTY50'] || 0;
                niftyInput.id = `team-${idx}-NIFTY50`;
                niftyInput.style = 'padding: 6px; border: 1px solid #000;';
                niftyDiv.appendChild(niftyLabel);
                niftyDiv.appendChild(niftyInput);
                holdingsGrid.appendChild(niftyDiv);
                
                // Stocks
                stocks.forEach(s => {
                    const stockDiv = document.createElement('div');
                    stockDiv.style = 'display: flex; flex-direction: column; gap: 4px;';
                    const label = document.createElement('label');
                    label.style = 'font-size: 0.85em; font-weight: bold;';
                    label.textContent = s.symbol;
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = data.holdings[s.symbol] || 0;
                    input.id = `team-${idx}-${s.symbol}`;
                    input.style = 'padding: 6px; border: 1px solid #000;';
                    stockDiv.appendChild(label);
                    stockDiv.appendChild(input);
                    holdingsGrid.appendChild(stockDiv);
                });
                
                section.appendChild(header);
                section.appendChild(holdingsGrid);
                container.appendChild(section);
            });
        }

        function addTeam() {
            const num = Object.keys(teams).length + 1;
            const name = `Team ${String.fromCharCode(64 + num)}`;
            teams[name] = { cash: 500000, holdings: {} };
            teams[name].holdings['NIFTY50'] = Math.floor(62500 / indexFund.open);
            stocks.forEach(s => teams[name].holdings[s.symbol] = Math.floor(50000 / s.open));
            renderTeamConfig();
        }

        function removeTeam(teamName) {
            const teamKeys = Object.keys(teams);
            if (teamKeys.length <= 2) {
                alert('Need at least 2 teams!');
                return;
            }
            if (!teams.hasOwnProperty(teamName)) {
                alert('Team not found: ' + teamName);
                return;
            }
            delete teams[teamName];
            renderTeamConfig();
            updateTeamDropdown();
            updateLeaderboard();
            renderTeamHoldings();
        }

        function saveTeamConfig() {
            const newTeams = {};
            Object.keys(teams).forEach((old, idx) => {
                const name = document.getElementById(`team-name-${idx}`).value || `Team ${idx+1}`;
                const cash = parseInt(document.getElementById(`team-cash-${idx}`).value) || 500000;
                const holdings = {};
                
                // Save NIFTY50 holdings
                holdings['NIFTY50'] = parseInt(document.getElementById(`team-${idx}-NIFTY50`).value) || 0;
                
                // Save stock holdings
                stocks.forEach(s => {
                    holdings[s.symbol] = parseInt(document.getElementById(`team-${idx}-${s.symbol}`).value) || 0;
                });
                newTeams[name] = { cash, holdings };
            });
            teams = newTeams;
            updateTeamDropdown();
            updateLeaderboard();
            alert('Teams saved!');
        }

        // DRIFT CONFIG
        function renderDriftConfig() {
            [1, 2, 3].forEach(session => {
                const container = document.getElementById(`drift-session-${session}`);
                container.innerHTML = '';
                
                stocks.forEach(stock => {
                    const news = flashNewsData.find(n => n.session === session && n.company === stock.symbol);
                    if (news) {
                        const div = document.createElement('div');
                        div.className = 'drift-grid';
                        
                        const symbolDiv = document.createElement('div');
                        symbolDiv.style.fontWeight = 'bold';
                        symbolDiv.textContent = stock.symbol;
                        
                        const minInput = document.createElement('input');
                        minInput.type = 'number';
                        minInput.step = '0.1';
                        minInput.value = news.driftMin;
                        minInput.id = `drift-${session}-${stock.symbol}-min`;
                        
                        const maxInput = document.createElement('input');
                        maxInput.type = 'number';
                        maxInput.step = '0.1';
                        maxInput.value = news.driftMax;
                        maxInput.id = `drift-${session}-${stock.symbol}-max`;
                        
                        const midInput = document.createElement('input');
                        midInput.type = 'number';
                        midInput.step = '0.1';
                        midInput.value = news.driftMid;
                        midInput.id = `drift-${session}-${stock.symbol}-mid`;
                        
                        div.appendChild(symbolDiv);
                        div.appendChild(minInput);
                        div.appendChild(maxInput);
                        div.appendChild(midInput);
                        container.appendChild(div);
                    }
                });
            });
        }

        function saveDriftConfig() {
            flashNewsData.forEach(news => {
                const min = parseFloat(document.getElementById(`drift-${news.session}-${news.company}-min`)?.value);
                const max = parseFloat(document.getElementById(`drift-${news.session}-${news.company}-max`)?.value);
                const mid = parseFloat(document.getElementById(`drift-${news.session}-${news.company}-mid`)?.value);
                if (!isNaN(min)) news.driftMin = min;
                if (!isNaN(max)) news.driftMax = max;
                if (!isNaN(mid)) news.driftMid = mid;
            });
            alert('Drift config saved!');
        }

        // NEWS CONFIG
        function renderNewsConfig() {
            [1, 2, 3].forEach(session => {
                const container = document.getElementById(`news-session-${session}`);
                container.innerHTML = '';
                
                stocks.forEach(stock => {
                    const news = flashNewsData.find(n => n.session === session && n.company === stock.symbol);
                    if (news) {
                        const div = document.createElement('div');
                        div.className = 'config-item';
                        
                        const label = document.createElement('label');
                        label.textContent = `${stock.name} (${stock.symbol})`;
                        
                        const textarea = document.createElement('textarea');
                        textarea.id = `news-${session}-${stock.symbol}`;
                        textarea.value = news.news;
                        
                        div.appendChild(label);
                        div.appendChild(textarea);
                        container.appendChild(div);
                    }
                });
            });
        }

        function saveNewsConfig() {
            flashNewsData.forEach(news => {
                const text = document.getElementById(`news-${news.session}-${news.company}`)?.value;
                if (text) news.news = text;
            });
            alert('News config saved!');
        }

        // INDEX FUND CONFIG
        function saveIndexConfig() {
            indexFund.name = document.getElementById('indexName').value;
            indexFund.value = parseFloat(document.getElementById('indexStart').value);
            indexFund.open = indexFund.value;
            indexFund.drift[1] = parseFloat(document.getElementById('indexDrift1').value);
            indexFund.drift[2] = parseFloat(document.getElementById('indexDrift2').value);
            indexFund.drift[3] = parseFloat(document.getElementById('indexDrift3').value);
            indexFund.history = [indexFund.value];
            updateIndexCard();
            alert('Index fund saved!');
        }

        // ==================== GAME LOGIC ====================

        function initializeTeamHoldings() {
            Object.keys(teams).forEach(name => {
                // Initialize stock holdings
                stocks.forEach(stock => {
                    if (!teams[name].holdings[stock.symbol]) {
                        teams[name].holdings[stock.symbol] = Math.floor(50000 / stock.open);
                    }
                });
                
                // Initialize NIFTY50 holdings
                if (!teams[name].holdings['NIFTY50']) {
                    teams[name].holdings['NIFTY50'] = Math.floor(62500 / indexFund.open);
                }
            });
            updateTeamDropdown();
            updateLeaderboard();
        }

        function updateTeamDropdown() {
            const select = document.getElementById('tradeTeam');
            select.innerHTML = '';
            Object.keys(teams).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });

            const stockSelect = document.getElementById('tradeStock');
            stockSelect.innerHTML = '';
            
            // Add NIFTY 50 first
            const indexOpt = document.createElement('option');
            indexOpt.value = 'NIFTY50';
            indexOpt.textContent = `${indexFund.name} (${indexFund.symbol})`;
            stockSelect.appendChild(indexOpt);
            
            // Add stocks
            stocks.forEach(stock => {
                const opt = document.createElement('option');
                opt.value = stock.symbol;
                opt.textContent = `${stock.name} (${stock.symbol})`;
                stockSelect.appendChild(opt);
            });
        }

        // Market Engine Functions
        function toggleMarketEngine() {
            const mode = document.getElementById('engineEnabled').value;
            if (mode === 'external') {
                if (typeof window.MarketEngine !== 'undefined' && window.MarketEngine.calculateImpact) {
                    marketEngine.enabled = 'external';
                    alert('Market Engine ENABLED - Using embedded engine');
                } else {
                    alert('‚ö†Ô∏è Market Engine not found!');
                    document.getElementById('engineEnabled').value = 'false';
                    marketEngine.enabled = false;
                }
            } else {
                marketEngine.enabled = mode === 'true';
                alert(`Built-in Market Engine ${marketEngine.enabled ? 'ENABLED' : 'DISABLED'}`);
            }
        }

        function saveEngineConfig() {
            marketEngine.params.depthFactor = parseFloat(document.getElementById('engineDepth').value);
            marketEngine.params.impactClamp = parseFloat(document.getElementById('engineClamp').value) / 100;
            
            Object.keys(marketEngine.config).forEach(symbol => {
                const k = parseFloat(document.getElementById(`engineK-${symbol}`)?.value);
                if (!isNaN(k)) marketEngine.config[symbol].K = k;
            });
            
            alert('Market Engine config saved!');
        }

        function calculateMarketImpact(symbol, side, qty, price) {
            // Check if external engine is enabled and available
            if (marketEngine.enabled === 'external' && typeof window.MarketEngine !== 'undefined') {
                try {
                    return window.MarketEngine.calculateImpact(symbol, side, qty, price);
                } catch (e) {
                    console.error('External engine error:', e);
                    return 0;
                }
            }
            
            // Use built-in engine
            if (!marketEngine.enabled || marketEngine.enabled === false) return 0;
            
            const config = marketEngine.config[symbol];
            if (!config) return 0;
            
            const instrument = symbol === 'NIFTY50' ? indexFund : stocks.find(s => s.symbol === symbol);
            if (!instrument) return 0;
            
            const direction = side === 'BUY' ? 1 : -1;
            const tradeValue = qty * price;
            const currentPrice = instrument.value || instrument.price;
            const liquidityValue = (config.dailyVolume * currentPrice) * marketEngine.params.depthFactor;
            
            const impact = direction * config.K * Math.sqrt(tradeValue / liquidityValue);
            const clampedImpact = Math.max(-marketEngine.params.impactClamp, 
                                           Math.min(marketEngine.params.impactClamp, impact));
            
            return clampedImpact;
        }

        function calculateNetWorth(name) {
            const team = teams[name];
            let total = team.cash;
            Object.entries(team.holdings).forEach(([sym, qty]) => {
                if (sym === 'NIFTY50') {
                    total += qty * indexFund.value;
                } else {
                    const stock = stocks.find(s => s.symbol === sym);
                    if (stock) total += qty * stock.price;
                }
            });
            return total;
        }

        function updateLeaderboard() {
            const rankings = Object.keys(teams).map(name => ({
                name,
                netWorth: calculateNetWorth(name),
                cash: teams[name].cash
            })).sort((a, b) => b.netWorth - a.netWorth);

            const container = document.getElementById('leaderboardContent');
            
            // Store previous positions for animation
            const previousPositions = {};
            container.querySelectorAll('.team-card').forEach((card, idx) => {
                const teamName = card.querySelector('.team-name')?.textContent;
                if (teamName) previousPositions[teamName] = idx;
            });
            
            container.innerHTML = '';

            rankings.forEach((team, idx) => {
                const card = document.createElement('div');
                card.className = `team-card ${idx === 0 ? 'rank-1' : ''}`;
                
                const holdings = team.netWorth - team.cash;
                
                // Check if position changed
                const prevPos = previousPositions[team.name];
                const positionChanged = prevPos !== undefined && prevPos !== idx;
                
                card.innerHTML = `
                    <div class="team-rank">#${idx + 1}</div>
                    <div class="team-name">${team.name}</div>
                    <div class="team-stats">
                        Cash: ‚Çπ${formatINR(team.cash)}<br>
                        Holdings: ‚Çπ${formatINR(holdings)}
                    </div>
                    <div class="team-networth">‚Çπ${formatINR(team.netWorth)}</div>
                `;
                
                // Add animation if position changed
                if (positionChanged) {
                    card.style.animation = 'slideInRank 0.5s ease-out';
                }
                
                container.appendChild(card);
            });

            // Also update the team holdings table
            renderTeamHoldings();
        }

        function renderTeamHoldings() {
            const container = document.getElementById('teamHoldingsTable');
            if (!container) return;

            const teamNames = Object.keys(teams);
            const allSymbols = ['NIFTY50', ...stocks.map(s => s.symbol)];
            const symbolNames = { NIFTY50: indexFund.name };
            stocks.forEach(s => symbolNames[s.symbol] = s.name);

            let html = '<table class="holdings-table"><thead><tr><th>Team</th>';
            allSymbols.forEach(sym => {
                html += `<th>${sym}</th>`;
            });
            html += '<th>Cash</th></tr></thead><tbody>';

            teamNames.forEach(name => {
                const team = teams[name];
                html += `<tr><td>${name}</td>`;
                allSymbols.forEach(sym => {
                    const qty = team.holdings[sym] || 0;
                    html += `<td class="${qty === 0 ? 'holdings-zero' : ''}">${qty}</td>`;
                });
                html += `<td>‚Çπ${formatINR(team.cash)}</td></tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateIndexCard() {
            const change = indexFund.value - indexFund.open;
            const pct = ((change / indexFund.open) * 100).toFixed(2);
            const isPos = change >= 0;
            
            document.getElementById('indexFundCard').innerHTML = `
                <div class="index-card">
                    <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">${indexFund.name}</div>
                    <div style="font-size: 1.5em; font-weight: bold; font-family: 'Courier New';">‚Çπ${indexFund.value.toFixed(2)}</div>
                    <div style="font-size: 0.9em; font-weight: bold; color: ${isPos ? '#16a34a' : '#dc2626'};">
                        ${isPos ? '‚ñ≤' : '‚ñº'} ‚Çπ${Math.abs(change).toFixed(2)} (${isPos ? '+' : ''}${pct}%)
                    </div>
                </div>
            `;
        }

        function executeTrade() {
            const team = document.getElementById('tradeTeam').value;
            const symbol = document.getElementById('tradeStock').value;
            const side = document.getElementById('tradeSide').value;
            const qty = parseInt(document.getElementById('tradeQty').value);
            const price = parseFloat(document.getElementById('tradePrice').value);

            console.log('Execute Trade:', { team, symbol, side, qty, price });

            if (!team) return alert('Please select a team!');
            if (!symbol) return alert('Please select a stock!');
            if (!qty || qty <= 0) return alert('Please enter a valid quantity!');
            if (!price || price <= 0) return alert('Please enter a valid price!');

            const teamData = teams[team];
            if (!teamData) return alert('Team not found!');
            
            const value = qty * price;

            // Validate order (check if team has resources)
            if (side === 'BUY') {
                if (teamData.cash < value) {
                    return alert(`Insufficient cash!\n\nTeam ${team} has: ‚Çπ${formatINR(teamData.cash)}\nNeeds: ‚Çπ${formatINR(value)}`);
                }
            } else {
                const currentHoldings = teamData.holdings[symbol] || 0;
                if (currentHoldings < qty) {
                    return alert(`Insufficient shares!\n\nTeam ${team} has: ${currentHoldings} ${symbol}\nTrying to sell: ${qty}`);
                }
            }

            // Create order
            const order = {
                id: orderIdCounter++,
                team,
                symbol,
                side,
                qty,
                price,
                timestamp: new Date()
            };

            console.log('Order created:', order);

            // Add to order book
            const book = orderBook[symbol];
            if (!book) {
                console.error('Order book not found for symbol:', symbol);
                return alert('Error: Order book not initialized!');
            }
            
            if (side === 'BUY') {
                book.buys.push(order);
                book.buys.sort((a, b) => b.price - a.price); // Highest price first
            } else {
                book.sells.push(order);
                book.sells.sort((a, b) => a.price - b.price); // Lowest price first
            }

            console.log('Order added to book:', symbol, book);

            // Try to match orders
            matchOrders(symbol);

            // Render order book
            renderOrderBook();

            // Clear form
            document.getElementById('tradeQty').value = '';
            document.getElementById('tradePrice').value = '';

            // Check if order was filled or is pending
            const stillPending = (side === 'BUY' && orderBook[symbol].buys.some(o => o.id === order.id)) ||
                                 (side === 'SELL' && orderBook[symbol].sells.some(o => o.id === order.id));
            
            if (stillPending) {
                const opposite = side === 'BUY' ? 'SELL' : 'BUY';
                alert(`‚úÖ ${side} order placed!\n\n${symbol}: ${qty} shares @ ‚Çπ${price.toFixed(2)}\n\nWaiting for ${opposite} order to match...`);
            } else {
                alert(`‚úÖ Trade executed!\n\n${symbol}: ${qty} shares @ ‚Çπ${price.toFixed(2)}\n\nCheck Executed Trades below!`);
            }
        }

        function matchOrders(symbol) {
            const book = orderBook[symbol];
            
            while (book.buys.length > 0 && book.sells.length > 0) {
                const buyOrder = book.buys[0];
                const sellOrder = book.sells[0];

                // Check if prices match (buy price >= sell price)
                if (buyOrder.price < sellOrder.price) break;

                // Match found! Execute trade
                const tradeQty = Math.min(buyOrder.qty, sellOrder.qty);
                const tradePrice = sellOrder.price; // Seller's price wins

                // Execute the trade
                const buyer = teams[buyOrder.team];
                const seller = teams[sellOrder.team];
                const tradeValue = tradeQty * tradePrice;

                // Update buyer
                buyer.cash -= tradeValue;
                buyer.holdings[symbol] = (buyer.holdings[symbol] || 0) + tradeQty;

                // Update seller
                seller.cash += tradeValue;
                seller.holdings[symbol] -= tradeQty;

                // Log the trade
                tradeLog.unshift({
                    buyer: buyOrder.team,
                    seller: sellOrder.team,
                    symbol,
                    qty: tradeQty,
                    price: tradePrice,
                    value: tradeValue,
                    timestamp: new Date()
                });

                // Update stock price
                if (symbol === 'NIFTY50') {
                    const impact = calculateMarketImpact(symbol, 'BUY', tradeQty, tradePrice);
                    if (marketEngine.enabled) {
                        indexFund.value *= (1 + impact);
                    } else {
                        indexFund.value = tradePrice;
                    }
                    updateIndexCard();
                    updateIndexStockCard();
                } else {
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (stock) {
                        const impact = calculateMarketImpact(symbol, 'BUY', tradeQty, tradePrice);
                        if (marketEngine.enabled) {
                            stock.price *= (1 + impact);
                        } else {
                            stock.price = tradePrice;
                        }
                        updateStockCard(symbol);
                    }
                }

                // Update order quantities or remove filled orders
                buyOrder.qty -= tradeQty;
                sellOrder.qty -= tradeQty;

                if (buyOrder.qty === 0) book.buys.shift();
                if (sellOrder.qty === 0) book.sells.shift();

                // Update displays
                renderTradeLog();
                updateLeaderboard();
            }
        }

        function cancelOrder(orderId, symbol, side) {
            const book = orderBook[symbol];
            const orders = side === 'BUY' ? book.buys : book.sells;
            const index = orders.findIndex(o => o.id === orderId);
            
            if (index !== -1) {
                orders.splice(index, 1);
                renderOrderBook();
                alert('Order cancelled');
            }
        }

        function renderOrderBook() {
            const container = document.getElementById('orderBookContent');
            if (!container) return;
            
            let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">';
            
            // Get all symbols with orders
            const symbolsWithOrders = Object.keys(orderBook).filter(sym => 
                orderBook[sym].buys.length > 0 || orderBook[sym].sells.length > 0
            );

            if (symbolsWithOrders.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No pending orders - Place a BUY or SELL order to start trading</div>';
                return;
            }

            symbolsWithOrders.forEach(symbol => {
                const book = orderBook[symbol];
                const canMatch = book.buys.length > 0 && book.sells.length > 0 && 
                                 book.buys[0].price >= book.sells[0].price;
                
                html += `
                    <div style="border: 2px solid ${canMatch ? '#4ade80' : '#000'}; padding: 12px; background: ${canMatch ? '#f0fdf4' : '#fff'};">
                        <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 8px;">
                            ${symbol}
                            ${canMatch ? '<span style="color: #16a34a; font-size: 0.8em; margin-left: 10px;">‚ö° READY TO MATCH</span>' : ''}
                        </div>
                        
                        ${book.sells.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <div style="font-weight: bold; color: #dc2626; font-size: 0.9em; margin-bottom: 5px;">üî¥ SELL Orders (${book.sells.length})</div>
                                ${book.sells.map(o => `
                                    <div style="background: #ffe6e6; padding: 6px; margin-bottom: 4px; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #dc2626;">
                                        <div>
                                            <strong>${o.team}</strong><br>
                                            <span style="font-family: 'Courier New';">${o.qty} shares @ ‚Çπ${o.price.toFixed(2)}</span>
                                        </div>
                                        <button onclick="cancelOrder(${o.id}, '${symbol}', 'SELL')" style="padding: 4px 8px; background: #dc2626; color: #fff; border: none; cursor: pointer; font-size: 0.8em; font-weight: bold;">‚úï</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #999; font-size: 0.85em; margin-bottom: 10px;">No SELL orders - Waiting for seller...</div>'}
                        
                        ${book.buys.length > 0 ? `
                            <div>
                                <div style="font-weight: bold; color: #16a34a; font-size: 0.9em; margin-bottom: 5px;">üü¢ BUY Orders (${book.buys.length})</div>
                                ${book.buys.map(o => `
                                    <div style="background: #e6ffe6; padding: 6px; margin-bottom: 4px; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #16a34a;">
                                        <div>
                                            <strong>${o.team}</strong><br>
                                            <span style="font-family: 'Courier New';">${o.qty} shares @ ‚Çπ${o.price.toFixed(2)}</span>
                                        </div>
                                        <button onclick="cancelOrder(${o.id}, '${symbol}', 'BUY')" style="padding: 4px 8px; background: #16a34a; color: #fff; border: none; cursor: pointer; font-size: 0.8em; font-weight: bold;">‚úï</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="color: #999; font-size: 0.85em;">No BUY orders - Waiting for buyer...</div>'}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderTradeLog() {
            const container = document.getElementById('tradesLogContent');
            if (!container) return;
            container.innerHTML = '';

            tradeLog.slice(0, 30).forEach(trade => {
                const row = document.createElement('div');
                row.className = 'trade-row';
                row.innerHTML = `
                    <div>${trade.buyer || trade.team}</div>
                    <div>${trade.seller || '-'}</div>
                    <div>${trade.symbol}</div>
                    <div>${trade.qty}</div>
                    <div>‚Çπ${trade.price.toFixed(2)}</div>
                    <div>${trade.timestamp.toLocaleTimeString()}</div>
                `;
                container.appendChild(row);
            });
        }

        function exportTrades() {
            let csv = "data:text/csv;charset=utf-8,Buyer,Seller,Symbol,Qty,Price,Value,Time\n";
            tradeLog.forEach(t => {
                const buyer = t.buyer || t.team;
                const seller = t.seller || '-';
                csv += `${buyer},${seller},${t.symbol},${t.qty},${t.price},${t.value},${t.timestamp.toISOString()}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI(csv);
            link.download = `trades_session_${currentSession}.csv`;
            link.click();
        }

        function clearTrades() {
            if (confirm('Clear all trades and orders?')) {
                tradeLog = [];
                initOrderBook();
                renderTradeLog();
                renderOrderBook();
            }
        }

        function toggleTrades() {
            const section = document.getElementById('tradeSection');
            section.classList.toggle('collapsed');
            document.getElementById('toggleTradeText').textContent = section.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        }

        // STOCK CARDS
        function renderStocks() {
            const grid = document.getElementById('stockGrid');
            grid.innerHTML = '';
            
            // Add NIFTY 50 card first
            renderIndexStockCard(grid);
            
            stocks.forEach(stock => {
                const change = stock.price - stock.open;
                const pct = ((change / stock.open) * 100).toFixed(2);
                const isPos = change >= 0;
                
                const card = document.createElement('div');
                card.className = 'stock-card';
                card.id = `stock-${stock.symbol}`;
                card.innerHTML = `
                    <div class="company-name">${stock.name}</div>
                    <div class="stock-symbol">${stock.symbol}</div>
                    <div class="current-price">‚Çπ${stock.price.toFixed(2)}</div>
                    <div class="price-change ${isPos ? 'positive' : 'negative'}">
                        ${isPos ? '‚ñ≤' : '‚ñº'} ‚Çπ${Math.abs(change).toFixed(2)} (${isPos ? '+' : ''}${pct}%)
                    </div>
                    <div class="mini-chart-container">
                        <canvas class="mini-chart" id="chart-${stock.symbol}"></canvas>
                    </div>
                    <div class="stats">
                        <div><span class="stat-label">Open:</span> <span class="stat-value">‚Çπ${stock.open.toFixed(2)}</span></div>
                        <div><span class="stat-label">Volume:</span> <span class="stat-value">${stock.volume}</span></div>
                    </div>
                `;
                grid.appendChild(card);
                drawMiniChart(stock.symbol);
            });
        }

        function renderIndexStockCard(grid) {
            const change = indexFund.value - indexFund.open;
            const pct = ((change / indexFund.open) * 100).toFixed(2);
            const isPos = change >= 0;
            
            const card = document.createElement('div');
            card.className = 'stock-card index-card';
            card.id = 'stock-NIFTY50';
            card.innerHTML = `
                <div class="company-name">${indexFund.name}</div>
                <div class="stock-symbol">${indexFund.symbol}</div>
                <div class="current-price">‚Çπ${indexFund.value.toFixed(2)}</div>
                <div class="price-change ${isPos ? 'positive' : 'negative'}">
                    ${isPos ? '‚ñ≤' : '‚ñº'} ‚Çπ${Math.abs(change).toFixed(2)} (${isPos ? '+' : ''}${pct}%)
                </div>
                <div class="mini-chart-container">
                    <canvas class="mini-chart" id="chart-NIFTY50"></canvas>
                </div>
                <div class="stats">
                    <div><span class="stat-label">Open:</span> <span class="stat-value">‚Çπ${indexFund.open.toFixed(2)}</span></div>
                    <div><span class="stat-label">Volume:</span> <span class="stat-value">${indexFund.volume}</span></div>
                </div>
            `;
            grid.appendChild(card);
            drawIndexChart();
        }

        function updateIndexStockCard() {
            const card = document.getElementById('stock-NIFTY50');
            if (!card) return;

            const change = indexFund.value - indexFund.open;
            const pct = ((change / indexFund.open) * 100).toFixed(2);
            const isPos = change >= 0;

            card.querySelector('.current-price').textContent = `‚Çπ${indexFund.value.toFixed(2)}`;
            card.querySelector('.price-change').className = `price-change ${isPos ? 'positive' : 'negative'}`;
            card.querySelector('.price-change').textContent = `${isPos ? '‚ñ≤' : '‚ñº'} ‚Çπ${Math.abs(change).toFixed(2)} (${isPos ? '+' : ''}${pct}%)`;

            indexFund.history.push(indexFund.value);
            if (indexFund.history.length > 100) indexFund.history.shift();

            drawIndexChart();
            card.classList.add('flash');
            setTimeout(() => card.classList.remove('flash'), 500);
        }

        function drawIndexChart() {
            const canvas = document.getElementById('chart-NIFTY50');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, width, height);
            
            const history = indexFund.history;
            if (history.length < 2) return;
            
            const min = Math.min(...history);
            const max = Math.max(...history);
            const range = max - min || 1;
            const padding = range * 0.1;
            const chartMin = min - padding;
            const chartMax = max + padding;
            const chartRange = chartMax - chartMin;
            
            const points = history.map((val, i) => ({
                x: (i / (history.length - 1)) * (width - 50),
                y: height - ((val - chartMin) / chartRange) * height
            }));
            
            const isPos = indexFund.value >= indexFund.open;
            const color = isPos ? '#16a34a' : '#dc2626';
            
            ctx.fillStyle = isPos ? 'rgba(22,163,74,0.08)' : 'rgba(220,38,38,0.08)';
            ctx.beginPath();
            ctx.moveTo(points[0].x, height);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(points[points.length - 1].x, height);
            ctx.fill();
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            points.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.stroke();
            
            const last = points[points.length - 1];
            ctx.fillStyle = color;
            ctx.font = 'bold 10px Courier';
            ctx.fillText(`‚Çπ${indexFund.value.toFixed(2)}`, width - 48, Math.max(12, Math.min(height - 4, last.y)));
        }

        function updateStockCard(symbol) {
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return;

            const card = document.getElementById(`stock-${symbol}`);
            if (!card) return;

            const change = stock.price - stock.open;
            const pct = ((change / stock.open) * 100).toFixed(2);
            const isPos = change >= 0;

            card.querySelector('.current-price').textContent = `‚Çπ${stock.price.toFixed(2)}`;
            card.querySelector('.price-change').className = `price-change ${isPos ? 'positive' : 'negative'}`;
            card.querySelector('.price-change').textContent = `${isPos ? '‚ñ≤' : '‚ñº'} ‚Çπ${Math.abs(change).toFixed(2)} (${isPos ? '+' : ''}${pct}%)`;

            stock.priceHistory.push(stock.price);
            if (stock.priceHistory.length > 100) stock.priceHistory.shift();

            drawMiniChart(symbol);
            card.classList.add('flash');
            setTimeout(() => card.classList.remove('flash'), 500);
        }

        function drawMiniChart(symbol) {
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return;
            
            const canvas = document.getElementById(`chart-${symbol}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, width, height);
            
            const history = stock.priceHistory;
            if (history.length < 2) return;
            
            const min = Math.min(...history);
            const max = Math.max(...history);
            const range = max - min || 1;
            const padding = range * 0.1;
            const chartMin = min - padding;
            const chartMax = max + padding;
            const chartRange = chartMax - chartMin;
            
            const points = history.map((price, i) => ({
                x: (i / (history.length - 1)) * (width - 50),
                y: height - ((price - chartMin) / chartRange) * height
            }));
            
            const isPos = stock.price >= stock.open;
            const color = isPos ? '#16a34a' : '#dc2626';
            
            ctx.fillStyle = isPos ? 'rgba(22,163,74,0.08)' : 'rgba(220,38,38,0.08)';
            ctx.beginPath();
            ctx.moveTo(points[0].x, height);
            points.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(points[points.length - 1].x, height);
            ctx.fill();
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            points.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.stroke();
            
            const last = points[points.length - 1];
            ctx.fillStyle = color;
            ctx.font = 'bold 10px Courier';
            ctx.fillText(`‚Çπ${stock.price.toFixed(2)}`, width - 48, Math.max(12, Math.min(height - 4, last.y)));
        }

        // NEWS
        function showFlashNews(item) {
            const stock = stocks.find(s => s.symbol === item.company);
            document.getElementById('flashCompany').textContent = stock?.name || item.company;
            document.getElementById('flashText').textContent = item.news;
            document.getElementById('flashOverlay').classList.add('show');

            setTimeout(() => {
                document.getElementById('flashOverlay').classList.remove('show');
            }, 2000);

            setTimeout(() => {
                if (stock) {
                    const drift = item.driftMin + Math.random() * (item.driftMax - item.driftMin);
                    const impact = (stock.price * drift) / 100;
                    const steps = Math.floor(SESSION_DURATION_MS / 2000);
                    const inc = impact / steps;
                    
                    let step = 0;
                    const anim = setInterval(() => {
                        if (!sessionStartTime || step >= steps || (Date.now() - sessionStartTime) >= SESSION_DURATION_MS) {
                            clearInterval(anim);
                            return;
                        }
                        stock.price += inc;
                        updateStockCard(stock.symbol);
                        step++;
                    }, 2000);
                    
                    allPriceAnimations.push(anim);
                    addToHistory(item, drift);
                }
            }, 2000);
        }

        function addToHistory(item, impact) {
            const stock = stocks.find(s => s.symbol === item.company);
            newsHistory.unshift({
                company: stock?.name || item.company,
                news: item.news,
                time: new Date(),
                session: currentSession
            });
            updateNewsHistory();
        }

        function updateNewsHistory() {
            const container = document.getElementById('newsHistory');
            container.innerHTML = '';
            newsHistory.filter(n => n.session === currentSession).forEach(item => {
                const div = document.createElement('div');
                div.className = 'news-item';
                div.innerHTML = `
                    <div class="news-company">${item.company}</div>
                    <div class="news-text">${item.news}</div>
                    <div class="news-time">${item.time.toLocaleTimeString()}</div>
                `;
                container.appendChild(div);
            });
        }

        // SESSION CONTROL
        function startSession() {
            if (isFlashNewsRunning) return;
            
            isFlashNewsRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('skipBtn').disabled = false;
            
            sessionStartTime = Date.now();
            startMarketClock();
            
            const news = flashNewsData.filter(n => n.session === currentSession);
            currentNewsIndex = 0;

            function showNext() {
                if (currentNewsIndex < news.length) {
                    showFlashNews(news[currentNewsIndex]);
                    currentNewsIndex++;
                    setTimeout(showNext, 3000);
                }
            }
            showNext();
        }

        function skipToEnd() {
            if (!sessionStartTime) return;
            
            allPriceAnimations.forEach(clearInterval);
            allPriceAnimations = [];
            sessionStartTime = null;
            
            flashNewsData.filter(n => n.session === currentSession).forEach(item => {
                const stock = stocks.find(s => s.symbol === item.company);
                if (stock) {
                    const drift = item.driftMin + Math.random() * (item.driftMax - item.driftMin);
                    stock.price += (stock.price * drift) / 100;
                    updateStockCard(stock.symbol);
                    
                    if (!newsHistory.some(h => h.company === stock.name && h.session === currentSession)) {
                        addToHistory(item, drift);
                    }
                }
            });
            
            const indexDrift = indexFund.drift[currentSession];
            indexFund.value += (indexFund.value * indexDrift) / 100;
            updateIndexCard();
            
            document.getElementById('marketClock').textContent = '15:30';
            document.getElementById('marketStatus').textContent = 'MARKET CLOSED';
            document.getElementById('marketStatus').className = 'market-status closed';
            stopMarketClock();
            
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('skipBtn').disabled = true;
        }

        function nextSession() {
            currentSession++;
            if (currentSession > 3) {
                currentSession = 1;
                stocks.forEach(s => {
                    s.price = s.open;
                    s.priceHistory = [s.open];
                    updateStockCard(s.symbol);
                });
                indexFund.value = indexFund.open;
                indexFund.history = [indexFund.open];
                updateIndexCard();
                updateIndexStockCard();
            }
            
            document.getElementById('sessionName').textContent = currentSession;
            isFlashNewsRunning = false;
            currentNewsIndex = 0;
            newsHistory = newsHistory.filter(n => n.session !== currentSession);
            updateNewsHistory();
            
            allPriceAnimations.forEach(clearInterval);
            allPriceAnimations = [];
            
            // Reset order book for new session
            initOrderBook();
            renderOrderBook();
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('skipBtn').disabled = true;
            
            resetMarketClock();
        }

        function startMarketClock() {
            marketClockInterval = setInterval(() => {
                if (!sessionStartTime) return;
                const elapsed = Date.now() - sessionStartTime;
                const progress = elapsed / SESSION_DURATION_MS;
                
                const minutes = MARKET_START_TIME.minutes + Math.floor(progress * 375);
                const hours = MARKET_START_TIME.hours + Math.floor(minutes / 60);
                const mins = minutes % 60;
                document.getElementById('marketClock').textContent = `${hours.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}`;
                
                const status = document.getElementById('marketStatus');
                if (progress < 0.9) {
                    status.textContent = 'MARKET OPEN';
                    status.className = 'market-status open';
                } else if (progress < 1) {
                    status.textContent = 'CLOSING SOON';
                    status.className = 'market-status closing';
                } else {
                    status.textContent = 'MARKET CLOSED';
                    status.className = 'market-status closed';
                    stopMarketClock();
                    document.getElementById('nextBtn').disabled = false;
                    document.getElementById('skipBtn').disabled = true;
                }
            }, 100);
            
            setTimeout(() => stopMarketClock(), SESSION_DURATION_MS);
        }

        function stopMarketClock() {
            if (marketClockInterval) {
                clearInterval(marketClockInterval);
                marketClockInterval = null;
            }
        }

        function resetMarketClock() {
            sessionStartTime = null;
            document.getElementById('marketClock').textContent = '09:15';
            document.getElementById('marketStatus').textContent = 'MARKET OPEN';
            document.getElementById('marketStatus').className = 'market-status open';
        }

        // Random fluctuations
        setInterval(() => {
            if (!sessionStartTime || (Date.now() - sessionStartTime) >= SESSION_DURATION_MS) return;
            
            stocks.forEach(stock => {
                stock.price += stock.price * (Math.random() - 0.5) * 0.003;
                if (stock.price < stock.open * 0.5) stock.price = stock.open * 0.5;
                updateStockCard(stock.symbol);
            });
            
            indexFund.value += indexFund.value * (Math.random() - 0.5) * 0.002;
            updateIndexCard();
            updateIndexStockCard();
            
            // Update leaderboard in real-time as prices change
            updateLeaderboard();
        }, 3000);

        // Additional real-time leaderboard update (faster for smoother position changes)
        setInterval(() => {
            updateLeaderboard();
        }, 1000);

        // Initialize
        initOrderBook();
        renderStocks();
        initializeTeamHoldings();
        updateIndexCard();
        renderTradeLog();
        renderOrderBook();
        renderTeamHoldings();
    </script>


</body>
</html>
