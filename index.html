<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMPORIO 2025 - Joseph's Stock Exchange</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }

        .main-content {
            flex: 1;
        }

        .order-book-section {
            background: #ffffff;
            border: 2px solid #000000;
            padding: 20px;
            margin-bottom: 20px;
        }

        .order-book-section.collapsed .order-book-grid,
        .order-book-section.collapsed .export-controls {
            display: none;
        }

        .order-book-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .order-book-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .toggle-btn {
            padding: 8px 16px;
            background: #000000;
            color: #ffffff;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
        }

        .toggle-btn:hover {
            background: #333333;
        }

        .order-book-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .company-order-book {
            border: 1px solid #000000;
            padding: 10px;
            background: #f9f9f9;
        }

        .company-order-book h4 {
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #000000;
            font-size: 1em;
        }

        .transaction-row {
            display: grid;
            grid-template-columns: 40px 60px 80px 80px 90px;
            gap: 5px;
            margin-bottom: 8px;
            align-items: center;
        }

        .transaction-row label {
            font-size: 0.75em;
            font-weight: bold;
        }

        .transaction-input {
            padding: 4px;
            border: 1px solid #000000;
            font-size: 0.85em;
            width: 100%;
        }

        .transaction-input:focus {
            outline: 2px solid #000000;
        }

        .transaction-input[readonly] {
            background: #e5e5e5;
            border: 1px solid #666;
        }

        .current-price-display {
            background: #000000;
            color: #ffffff;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .export-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .history-sidebar {
            width: 350px;
            background: #ffffff;
            border: 2px solid #000000;
            padding: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .history-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .history-item {
            background: #f5f5f5;
            border: 1px solid #000000;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: #e5e5e5;
        }

        .history-item.new {
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .history-company {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .history-impact {
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .history-impact.positive {
            color: #000000;
        }

        .history-impact.negative {
            color: #666666;
        }

        .history-text {
            font-size: 0.85em;
            line-height: 1.4;
            color: #333333;
        }

        .history-time {
            font-size: 0.75em;
            color: #666666;
            margin-top: 8px;
            font-style: italic;
        }

        .no-history {
            text-align: center;
            color: #666666;
            padding: 20px;
            font-style: italic;
        }

        .header {
            text-align: center;
            color: #000000;
            margin-bottom: 30px;
            padding: 20px;
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header h2 {
            font-size: 1.5em;
            font-weight: 300;
            color: #333333;
        }

        .flash-news-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: #000000;
            padding: 40px;
            border-radius: 0;
            box-shadow: 0 0 0 3px #000000;
            z-index: 1000;
            max-width: 600px;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .flash-news-container.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .flash-news-header {
            color: #ffffff;
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .flash-news-company {
            color: #ffffff;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #ffffff;
            padding-bottom: 10px;
        }

        .flash-news-text {
            color: #ffffff;
            font-size: 1.1em;
            line-height: 1.6;
            text-align: center;
        }

        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stock-card {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 0;
            padding: 25px;
            box-shadow: 4px 4px 0 #000000;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stock-card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000000;
        }

        .stock-card.flash {
            animation: flashCard 1s ease-in-out;
        }

        @keyframes flashCard {
            0%, 100% { background: #ffffff; }
            50% { background: #f0f0f0; }
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .company-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        .stock-symbol {
            font-size: 0.9em;
            color: #666;
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .price-section {
            margin: 20px 0;
        }

        .current-price {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .price-change {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .price-change.positive {
            color: #000000;
        }

        .price-change.negative {
            color: #666666;
        }

        .arrow {
            font-size: 1.5em;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #000000;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .session-info {
            background: #000000;
            color: #ffffff;
            padding: 15px;
            border-radius: 0;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #000000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .time-controls {
            background: #ffffff;
            border: 2px solid #000000;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .time-controls label {
            font-weight: bold;
            color: #000000;
        }

        .time-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e5e5e5;
            outline: none;
            border: 1px solid #000000;
        }

        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #000000;
            cursor: pointer;
        }

        .time-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #000000;
            cursor: pointer;
            border: none;
        }

        .speed-display {
            font-weight: bold;
            color: #000000;
            min-width: 80px;
        }

        .session-label {
            font-size: 1.2em;
            font-weight: bold;
        }

        .market-clock {
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .market-status {
            font-size: 0.9em;
            padding: 5px 15px;
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
        }

        .market-status.open {
            background: #4ade80;
        }

        .market-status.closing {
            background: #fbbf24;
        }

        .market-status.closed {
            background: #ef4444;
            color: #ffffff;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 25px;
            border: 2px solid #000000;
            border-radius: 0;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #000000;
            background: #ffffff;
        }

        .btn-primary {
            background: #000000;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #333333;
        }

        .btn-success {
            background: #ffffff;
            color: #000000;
        }

        .btn-success:hover {
            background: #f0f0f0;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    
    <div class="flash-news-container" id="flashNews">
        <div class="flash-news-header">üì∞ FLASH NEWS üì∞</div>
        <div class="flash-news-company" id="newsCompany"></div>
        <div class="flash-news-text" id="newsText"></div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üèõÔ∏è EMPORIO 2025</h1>
                <h2>Joseph's Stock Exchange</h2>
            </div>

            <div class="session-info">
                <div class="session-label">Session: <span id="sessionName">1</span></div>
                <div class="market-clock" id="marketClock">09:15</div>
                <div class="market-status open" id="marketStatus">MARKET OPEN</div>
            </div>

            <div class="time-controls">
                <label>‚ö° Time Speed:</label>
                <input type="range" min="1" max="100" value="1" class="time-slider" id="timeSlider" oninput="updateTimeSpeed(this.value)">
                <span class="speed-display" id="speedDisplay">1x (Real-time)</span>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn" onclick="startSession()">Start Session</button>
                <button class="btn btn-success" id="nextBtn" onclick="nextSession()" disabled>Next Session</button>
            </div>

            <div class="order-book-section" id="orderBookSection">
                <div class="order-book-header">
                    <div class="order-book-title">üìä Order Book - Live Transactions</div>
                    <button class="toggle-btn" onclick="toggleOrderBook()">
                        <span id="toggleText">‚ñº Hide</span>
                    </button>
                </div>
                <div class="order-book-grid" id="orderBookGrid"></div>
                <div class="export-controls">
                    <button class="btn btn-success" onclick="exportToExcel()">üì• Export to Excel</button>
                    <button class="btn btn-primary" onclick="clearAllTransactions()">üóëÔ∏è Clear All</button>
                </div>
            </div>

            <div class="stock-grid" id="stockGrid"></div>
        </div>

        <div class="history-sidebar">
            <div class="history-title">üìú Flash News History</div>
            <div id="historyContainer">
                <div class="no-history">No news yet. Click "Start Flash News" to begin.</div>
            </div>
        </div>
    </div>

    <script>
        // Stock data with initial prices (exact starting values as specified)
        const stocks = [
            { 
                name: 'Adani Ports', 
                symbol: 'ADANIPORTS', 
                price: 850.00, 
                open: 850.00,
                high: 852.50,
                low: 847.80,
                volume: '2.5M'
            },
            { 
                name: 'L&T', 
                symbol: 'LT', 
                price: 3400.00, 
                open: 3400.00,
                high: 3408.75,
                low: 3392.30,
                volume: '3.2M'
            },
            { 
                name: 'JSW Steel', 
                symbol: 'JSWSTEEL', 
                price: 820.00, 
                open: 820.00,
                high: 823.60,
                low: 816.45,
                volume: '8.5M'
            },
            { 
                name: 'ONGC', 
                symbol: 'ONGC', 
                price: 260.00, 
                open: 260.00,
                high: 261.85,
                low: 258.20,
                volume: '12.8M'
            },
            { 
                name: 'TCS', 
                symbol: 'TCS', 
                price: 4100.00, 
                open: 4100.00,
                high: 4112.50,
                low: 4088.90,
                volume: '1.8M'
            },
            { 
                name: 'Titan', 
                symbol: 'TITAN', 
                price: 3600.00, 
                open: 3600.00,
                high: 3614.80,
                low: 3587.25,
                volume: '2.8M'
            },
            { 
                name: 'CEAT', 
                symbol: 'CEATLTD', 
                price: 2800.00, 
                open: 2800.00,
                high: 2811.40,
                low: 2788.65,
                volume: '680K'
            },
            { 
                name: 'State Bank of India', 
                symbol: 'SBIN', 
                price: 720.00, 
                open: 720.00,
                high: 723.90,
                low: 716.35,
                volume: '18.5M'
            }
        ];

        // Flash news from PowerPoint
        const flashNewsData = [
            // Session 1 - Chaotic Open (Immediate swings, not everyone wins)
            {
                session: 1,
                company: 'ADANIPORTS',
                news: 'Overseas terminal operations stabilise, but initial throughput ramp-up remains uneven across routes.',
                impact: 3.0
            },
            {
                session: 1,
                company: 'LT',
                news: 'Secures a large infrastructure contract, though early capital deployment requirements are high.',
                impact: -2.0
            },
            {
                session: 1,
                company: 'JSWSTEEL',
                news: 'Production optimisation boosts output efficiency across key facilities.',
                impact: 4.0
            },
            {
                session: 1,
                company: 'ONGC',
                news: 'New offshore exploration plan announced, but execution timelines remain uncertain.',
                impact: -3.0
            },
            {
                session: 1,
                company: 'TCS',
                news: 'Wins multiple enterprise AI deals but faces pricing competition from global tech firms.',
                impact: 2.0
            },
            {
                session: 1,
                company: 'TITAN',
                news: 'Premium jewellery demand steady, but gold price volatility affecting customer buying behaviour.',
                impact: -2.0
            },
            {
                session: 1,
                company: 'CEATLTD',
                news: 'Capacity expansion plans announced to support growing auto demand.',
                impact: 3.0
            },
            {
                session: 1,
                company: 'SBIN',
                news: 'Credit growth strong, but liquidity tightening concerns emerging in banking sector.',
                impact: -1.0
            },
            // Session 2 - Reversal Day (Winners become losers, losers recover)
            {
                session: 2,
                company: 'ADANIPORTS',
                news: 'Logistics demand remains strong, but higher port handling costs being reported.',
                impact: -2.0
            },
            {
                session: 2,
                company: 'LT',
                news: 'Execution progress on infrastructure projects improves confidence among investors.',
                impact: 4.0
            },
            {
                session: 2,
                company: 'JSWSTEEL',
                news: 'Rising raw material costs begin affecting margin expectations across steel producers.',
                impact: -3.0
            },
            {
                session: 2,
                company: 'ONGC',
                news: 'Exploration activity gains momentum with new geological data insights.',
                impact: 3.0
            },
            {
                session: 2,
                company: 'TCS',
                news: 'Global IT spending outlook stabilises, supporting deal pipeline strength.',
                impact: 2.0
            },
            {
                session: 2,
                company: 'TITAN',
                news: 'Retail sales momentum improves in urban markets with rising premium demand.',
                impact: 3.0
            },
            {
                session: 2,
                company: 'CEATLTD',
                news: 'Freight and rubber costs increase, putting pressure on operational margins.',
                impact: -2.0
            },
            {
                session: 2,
                company: 'SBIN',
                news: 'Institutional inflows support banking stocks amid improving lending sentiment.',
                impact: 2.0
            },
            // Session 3 - Final Session (Volatile as hell)
            {
                session: 3,
                company: 'ADANIPORTS',
                news: 'Cargo volumes surge across key terminals, strengthening logistics outlook.',
                impact: 5.0
            },
            {
                session: 3,
                company: 'LT',
                news: 'Market chatter highlights project execution risks and possible margin compression.',
                impact: -4.0
            },
            {
                session: 3,
                company: 'JSWSTEEL',
                news: 'Demand outlook improves slightly as infrastructure spending picks up.',
                impact: 3.0
            },
            {
                session: 3,
                company: 'ONGC',
                news: 'Energy price fluctuations create uncertainty in upstream planning decisions.',
                impact: -3.0
            },
            {
                session: 3,
                company: 'TCS',
                news: 'Major enterprise contract announcement boosts sentiment late in the session.',
                impact: 4.0
            },
            {
                session: 3,
                company: 'TITAN',
                news: 'Sudden spike in festive jewellery demand drives strong late buying.',
                impact: 5.0
            },
            {
                session: 3,
                company: 'CEATLTD',
                news: 'Export orders increase unexpectedly, improving near-term business outlook.',
                impact: 3.0
            },
            {
                session: 3,
                company: 'SBIN',
                news: 'Funding cost pressures intensify across the banking system.',
                impact: -3.0
            }
        ];

        let currentSession = 1;
        let newsInterval;
        let currentNewsIndex = 0;
        let isFlashNewsRunning = false;
        let newsHistory = [];
        let marketClockInterval = null;
        let sessionStartTime = null;
        const SESSION_DURATION_MS = 15 * 60 * 1000; // 15 minutes in milliseconds
        const MARKET_START_TIME = { hours: 9, minutes: 15 };
        const MARKET_END_TIME = { hours: 15, minutes: 30 };
        let timeSpeed = 1; // Speed multiplier (1 = real-time, 100 = 100x faster)

        // Order book structure: { symbol: [{ qty, price, amt, newPrice }] }
        let orderBook = {};

        // Update time speed
        function updateTimeSpeed(value) {
            timeSpeed = parseInt(value);
            const speedDisplay = document.getElementById('speedDisplay');
            
            if (timeSpeed === 1) {
                speedDisplay.textContent = '1x (Real-time)';
            } else if (timeSpeed <= 5) {
                speedDisplay.textContent = timeSpeed + 'x';
            } else if (timeSpeed <= 20) {
                speedDisplay.textContent = timeSpeed + 'x (Fast)';
            } else if (timeSpeed <= 50) {
                speedDisplay.textContent = timeSpeed + 'x (Very Fast)';
            } else {
                speedDisplay.textContent = timeSpeed + 'x (TURBO)';
            }
        }

        // Initialize order book for each stock
        function initializeOrderBook() {
            stocks.forEach(stock => {
                if (!orderBook[stock.symbol]) {
                    orderBook[stock.symbol] = [];
                }
            });
            renderOrderBook();
        }

        // Render the order book UI
        function renderOrderBook() {
            const grid = document.getElementById('orderBookGrid');
            grid.innerHTML = '';

            stocks.forEach(stock => {
                const bookDiv = document.createElement('div');
                bookDiv.className = 'company-order-book';
                bookDiv.innerHTML = `
                    <h4>${stock.symbol}</h4>
                    <div id="transactions-${stock.symbol}">
                        ${renderTransactions(stock.symbol)}
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 10px; padding: 6px; font-size: 0.85em;" onclick="addTransaction('${stock.symbol}')">+ Add Transaction</button>
                    <div class="current-price-display">
                        Current: ‚Çπ<span id="ob-price-${stock.symbol}">${stock.price.toFixed(2)}</span>
                    </div>
                `;
                grid.appendChild(bookDiv);
            });
        }

        // Render transactions for a specific stock
        function renderTransactions(symbol) {
            const transactions = orderBook[symbol] || [];
            if (transactions.length === 0) {
                return '<div style="text-align: center; color: #666; padding: 10px; font-size: 0.85em;">No transactions yet</div>';
            }

            return transactions.map((t, idx) => `
                <div class="transaction-row">
                    <label>T${idx + 1}</label>
                    <input type="number" class="transaction-input" placeholder="QTY" value="${t.qty || ''}" 
                           onchange="updateTransaction('${symbol}', ${idx}, 'qty', this.value)">
                    <input type="number" class="transaction-input" placeholder="PRICE" value="${t.price || ''}" 
                           onchange="updateTransaction('${symbol}', ${idx}, 'price', this.value)">
                    <input type="number" class="transaction-input" readonly value="${t.amt || ''}" placeholder="AMT">
                    <input type="number" class="transaction-input" readonly value="${t.newPrice || ''}" placeholder="NEW PRICE">
                </div>
            `).join('');
        }

        // Add a new transaction
        function addTransaction(symbol) {
            if (!orderBook[symbol]) {
                orderBook[symbol] = [];
            }
            orderBook[symbol].push({ qty: '', price: '', amt: '', newPrice: '' });
            refreshOrderBook(symbol);
        }

        // Update transaction values
        function updateTransaction(symbol, index, field, value) {
            const transaction = orderBook[symbol][index];
            transaction[field] = parseFloat(value) || '';

            // Calculate AMT
            if (transaction.qty && transaction.price) {
                transaction.amt = transaction.qty * transaction.price;
            }

            // Recalculate weighted average (NEW PRICE) for all transactions
            calculateWeightedAverage(symbol);
            refreshOrderBook(symbol);
        }

        // Calculate weighted average price for a stock
        function calculateWeightedAverage(symbol) {
            const transactions = orderBook[symbol];
            let totalQty = 0;
            let totalAmt = 0;

            transactions.forEach(t => {
                if (t.qty && t.price) {
                    totalQty += parseFloat(t.qty);
                    totalAmt += parseFloat(t.amt);
                }
            });

            const weightedAvg = totalQty > 0 ? totalAmt / totalQty : null;

            // Update all transaction newPrice fields
            transactions.forEach(t => {
                t.newPrice = weightedAvg ? weightedAvg.toFixed(2) : '';
            });

            // Update the actual stock price if we have a valid weighted average
            if (weightedAvg) {
                const stock = stocks.find(s => s.symbol === symbol);
                if (stock) {
                    stock.price = weightedAvg;
                    updateStockCard(symbol);
                    
                    // Update the order book display price
                    const priceEl = document.getElementById(`ob-price-${symbol}`);
                    if (priceEl) {
                        priceEl.textContent = weightedAvg.toFixed(2);
                    }
                }
            }
        }

        // Refresh order book display for a specific stock
        function refreshOrderBook(symbol) {
            const container = document.getElementById(`transactions-${symbol}`);
            if (container) {
                container.innerHTML = renderTransactions(symbol);
            }
        }

        // Clear all transactions
        function clearAllTransactions() {
            if (!confirm('Clear all transactions? This cannot be undone.')) return;
            
            orderBook = {};
            stocks.forEach(stock => {
                orderBook[stock.symbol] = [];
                stock.price = stock.open;
                updateStockCard(stock.symbol);
            });
            renderOrderBook();
        }

        // Export to Excel
        function exportToExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add header
            csvContent += "Session " + currentSession + " - Order Book Export\n\n";
            
            stocks.forEach(stock => {
                csvContent += stock.name + " (" + stock.symbol + ")\n";
                csvContent += "Transaction,QTY,PRICE,AMT,NEW PRICE\n";
                
                const transactions = orderBook[stock.symbol] || [];
                transactions.forEach((t, idx) => {
                    csvContent += `T${idx + 1},${t.qty || ''},${t.price || ''},${t.amt || ''},${t.newPrice || ''}\n`;
                });
                
                csvContent += `\nCurrent Price: ‚Çπ${stock.price.toFixed(2)}\n\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `session_${currentSession}_orderbook.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Toggle order book visibility
        function toggleOrderBook() {
            const section = document.getElementById('orderBookSection');
            const toggleText = document.getElementById('toggleText');
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                toggleText.textContent = '‚ñº Hide';
            } else {
                section.classList.add('collapsed');
                toggleText.textContent = '‚ñ∂ Show';
            }
        }

        // Convert real time (9:15 to 15:30) to elapsed milliseconds in 15-minute window
        function getMarketTime(elapsedMs) {
            // Apply time speed multiplier
            const acceleratedElapsed = elapsedMs * timeSpeed;
            
            // Total market duration: 9:15 to 15:30 = 6h 15min = 375 minutes
            const totalMarketMinutes = 375;
            const progressRatio = acceleratedElapsed / SESSION_DURATION_MS;
            const currentMarketMinutes = Math.floor(progressRatio * totalMarketMinutes);
            
            let hours = MARKET_START_TIME.hours;
            let minutes = MARKET_START_TIME.minutes + currentMarketMinutes;
            
            // Handle hour rollovers
            while (minutes >= 60) {
                minutes -= 60;
                hours += 1;
            }
            
            return { hours, minutes };
        }

        function formatTime(hours, minutes) {
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function updateMarketClock() {
            if (!sessionStartTime) return;
            
            const elapsed = Date.now() - sessionStartTime;
            const acceleratedElapsed = elapsed * timeSpeed;
            const time = getMarketTime(elapsed);
            const timeString = formatTime(time.hours, time.minutes);
            
            document.getElementById('marketClock').textContent = timeString;
            
            // Update market status
            const statusEl = document.getElementById('marketStatus');
            const progressPercent = (acceleratedElapsed / SESSION_DURATION_MS) * 100;
            
            if (progressPercent < 90) {
                statusEl.textContent = 'MARKET OPEN';
                statusEl.className = 'market-status open';
            } else if (progressPercent < 100) {
                statusEl.textContent = 'CLOSING SOON';
                statusEl.className = 'market-status closing';
            } else {
                statusEl.textContent = 'MARKET CLOSED';
                statusEl.className = 'market-status closed';
                stopMarketClock();
                
                // Enable next session button
                document.getElementById('nextBtn').disabled = false;
                document.getElementById('startBtn').disabled = true;
            }
        }

        function startMarketClock() {
            sessionStartTime = Date.now();
            updateMarketClock();
            
            // Update every 100ms for smooth animation
            marketClockInterval = setInterval(updateMarketClock, 100);
            
            // Auto-stop based on time speed
            const adjustedDuration = SESSION_DURATION_MS / timeSpeed;
            setTimeout(() => {
                stopMarketClock();
            }, adjustedDuration);
        }

        function stopMarketClock() {
            if (marketClockInterval) {
                clearInterval(marketClockInterval);
                marketClockInterval = null;
            }
        }

        function resetMarketClock() {
            stopMarketClock();
            sessionStartTime = null;
            document.getElementById('marketClock').textContent = '09:15';
            document.getElementById('marketStatus').textContent = 'MARKET OPEN';
            document.getElementById('marketStatus').className = 'market-status open';
        }

        // Function to add news to history
        function addToHistory(newsItem, impact) {
            const historyContainer = document.getElementById('historyContainer');
            
            // Remove "no history" message if it exists
            const noHistory = historyContainer.querySelector('.no-history');
            if (noHistory) {
                noHistory.remove();
            }

            const historyItem = document.createElement('div');
            historyItem.className = 'history-item new';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            historyItem.innerHTML = `
                <div class="history-company">${newsItem.company}</div>
                <div class="history-text">${newsItem.news}</div>
                <div class="history-time">${timeString}</div>
            `;
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
            newsHistory.push({...newsItem, time: timeString, impact: impact});
        }

        // Function to clear history when changing sessions
        function clearHistory() {
            const historyContainer = document.getElementById('historyContainer');
            historyContainer.innerHTML = '<div class="no-history">No news yet. Click "Start Flash News" to begin.</div>';
            newsHistory = [];
        }

        // Function to load prices from JSON (generated from Excel)
        async function loadPricesFromExcel() {
            try {
                const response = await fetch('stock_prices.json');
                if (!response.ok) {
                    throw new Error('Could not load stock_prices.json');
                }
                
                const priceData = await response.json();
                
                // Update stock prices from the loaded data
                let updatedCount = 0;
                stocks.forEach(stock => {
                    if (priceData[stock.symbol]) {
                        const newPrice = priceData[stock.symbol].price;
                        if (newPrice && newPrice > 0) {
                            stock.price = newPrice;
                            stock.open = newPrice * 0.995; // Set open slightly lower
                            stock.high = newPrice * 1.01;
                            stock.low = newPrice * 0.99;
                            updateStockCard(stock.symbol);
                            updatedCount++;
                        }
                    }
                });
                
                if (updatedCount > 0) {
                    alert(`‚úì Successfully updated ${updatedCount} stock prices from Excel!`);
                } else {
                    alert('‚ÑπÔ∏è No prices found in Excel file. Please fill in QTY and PRICE columns in the Excel sheet, then run the Python script to generate stock_prices.json');
                }
                
            } catch (error) {
                console.error('Error loading prices:', error);
                alert(`To connect Excel prices:
                
1. Fill in QTY and PRICE columns in your Excel file
2. Run: python3 extract_prices.py
3. This generates stock_prices.json
4. Place the JSON file in the same folder as this HTML
5. Click "Reload Prices from Excel" again

Currently using default sample prices.`);
            }
        }

        // Initialize stock cards
        function renderStocks() {
            const grid = document.getElementById('stockGrid');
            grid.innerHTML = '';
            
            stocks.forEach((stock, index) => {
                const change = stock.price - stock.open;
                const changePercent = ((change / stock.open) * 100).toFixed(2);
                const isPositive = change >= 0;
                
                const card = document.createElement('div');
                card.className = 'stock-card';
                card.id = `stock-${stock.symbol}`;
                card.innerHTML = `
                    <div class="stock-header">
                        <div class="company-name">${stock.name}</div>
                        <div class="stock-symbol">${stock.symbol}</div>
                    </div>
                    <div class="price-section">
                        <div class="current-price">‚Çπ${stock.price.toFixed(2)}</div>
                        <div class="price-change ${isPositive ? 'positive' : 'negative'}">
                            <span class="arrow">${isPositive ? '‚ñ≤' : '‚ñº'}</span>
                            <span>‚Çπ${Math.abs(change).toFixed(2)} (${isPositive ? '+' : ''}${changePercent}%)</span>
                        </div>
                    </div>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">High</div>
                            <div class="stat-value">‚Çπ${stock.high.toFixed(2)}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Low</div>
                            <div class="stat-value">‚Çπ${stock.low.toFixed(2)}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Open</div>
                            <div class="stat-value">‚Çπ${stock.open.toFixed(2)}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Volume</div>
                            <div class="stat-value">${stock.volume}</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function updateStockCard(symbol) {
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return;

            const card = document.getElementById(`stock-${symbol}`);
            if (!card) return;

            const change = stock.price - stock.open;
            const changePercent = ((change / stock.open) * 100).toFixed(2);
            const isPositive = change >= 0;

            card.querySelector('.current-price').textContent = `‚Çπ${stock.price.toFixed(2)}`;
            
            const priceChange = card.querySelector('.price-change');
            priceChange.className = `price-change ${isPositive ? 'positive' : 'negative'}`;
            priceChange.innerHTML = `
                <span class="arrow">${isPositive ? '‚ñ≤' : '‚ñº'}</span>
                <span>‚Çπ${Math.abs(change).toFixed(2)} (${isPositive ? '+' : ''}${changePercent}%)</span>
            `;

            // Update high/low if needed
            if (stock.price > stock.high) {
                stock.high = stock.price;
                card.querySelectorAll('.stat-value')[0].textContent = `‚Çπ${stock.high.toFixed(2)}`;
            }
            if (stock.price < stock.low) {
                stock.low = stock.price;
                card.querySelectorAll('.stat-value')[1].textContent = `‚Çπ${stock.low.toFixed(2)}`;
            }

            // Flash animation
            card.classList.add('flash');
            setTimeout(() => card.classList.remove('flash'), 1000);
        }

        function showFlashNews(newsItem) {
            const overlay = document.getElementById('overlay');
            const flashNews = document.getElementById('flashNews');
            const newsCompany = document.getElementById('newsCompany');
            const newsText = document.getElementById('newsText');

            newsCompany.textContent = newsItem.company;
            newsText.textContent = newsItem.news;

            overlay.classList.add('show');
            flashNews.classList.add('show');

            // Apply price impact GRADUALLY over the entire 15-minute session
            setTimeout(() => {
                const stock = stocks.find(s => s.symbol === newsItem.company || s.symbol.includes(newsItem.company.split(' ')[0]));
                if (stock) {
                    const totalImpact = (stock.price * newsItem.impact) / 100;
                    
                    // Spread the movement over session duration (adjusted for speed)
                    // At 1x speed: 900 seconds (15 min), at 100x: 9 seconds
                    const sessionDurationSeconds = (SESSION_DURATION_MS / 1000) / timeSpeed;
                    const updateInterval = 2000; // Still update every 2 seconds
                    const totalSteps = Math.floor(sessionDurationSeconds / 2);
                    const incrementPerStep = totalImpact / totalSteps;
                    
                    let currentStep = 0;
                    
                    const priceAnimation = setInterval(() => {
                        if (!sessionStartTime) {
                            clearInterval(priceAnimation);
                            return;
                        }
                        
                        const elapsed = Date.now() - sessionStartTime;
                        const acceleratedElapsed = elapsed * timeSpeed;
                        
                        if (currentStep < totalSteps && acceleratedElapsed < SESSION_DURATION_MS) {
                            stock.price += incrementPerStep;
                            updateStockCard(stock.symbol);
                            currentStep++;
                        } else {
                            clearInterval(priceAnimation);
                        }
                    }, updateInterval);
                    
                    // Add to history
                    addToHistory(newsItem, newsItem.impact);
                }
            }, 2000);

            // Hide flash news after 2 seconds
            setTimeout(() => {
                overlay.classList.remove('show');
                flashNews.classList.remove('show');
            }, 2000);
        }

        function startSession() {
            if (isFlashNewsRunning) return;
            
            isFlashNewsRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            
            // Start the market clock
            startMarketClock();
            
            const sessionNews = flashNewsData.filter(n => n.session === currentSession);
            currentNewsIndex = 0;

            function showNextNews() {
                if (currentNewsIndex < sessionNews.length) {
                    showFlashNews(sessionNews[currentNewsIndex]);
                    currentNewsIndex++;
                    setTimeout(showNextNews, 3000); // Show next news after 3 seconds
                } else {
                    // All news shown, but session continues until market closes
                }
            }

            showNextNews();
        }

        function nextSession() {
            currentSession++;
            if (currentSession > 3) {
                currentSession = 1;
                // Reset all stock prices to opening values
                stocks.forEach(stock => {
                    stock.price = stock.open;
                    stock.high = stock.open * 1.003;
                    stock.low = stock.open * 0.997;
                    updateStockCard(stock.symbol);
                });
            }
            
            document.getElementById('sessionName').textContent = currentSession;
            isFlashNewsRunning = false;
            currentNewsIndex = 0;
            clearHistory();
            resetMarketClock();
            
            // Re-enable start button, disable next button
            document.getElementById('startBtn').disabled = false;
            document.getElementById('nextBtn').disabled = true;
        }

        // Initialize
        renderStocks();
        initializeOrderBook();

        // Random price fluctuations (small movements every 3 seconds)
        setInterval(() => {
            // Only update prices if market is open (session is running)
            if (!sessionStartTime) return; // Market hasn't started
            
            const elapsed = Date.now() - sessionStartTime;
            const acceleratedElapsed = elapsed * timeSpeed;
            if (acceleratedElapsed >= SESSION_DURATION_MS) return; // Market has closed
            
            stocks.forEach(stock => {
                // Calculate realistic random change: 0.05% to 0.15% of current price
                const percentChange = (Math.random() - 0.5) * 0.003; // -0.15% to +0.15%
                const randomChange = stock.price * percentChange;
                stock.price += randomChange;
                
                // Ensure price doesn't go negative
                if (stock.price < stock.open * 0.5) {
                    stock.price = stock.open * 0.5;
                }
                
                updateStockCard(stock.symbol);
            });
        }, 3000);
    </script>
</body>
</html>
